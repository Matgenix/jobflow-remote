
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>jobflow_remote.jobs.jobcontroller &#8212; Jobflow Remote v0.0.1 Manual</title>



  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>

  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />


  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../../../_static/jobflow_remote.css?v=7b6df8f0" />

  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script src="../../../_static/documentation_options.js?v=e135783d"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/design-tabs.js?v=36754332"></script>
    <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/jobflow_remote/jobs/jobcontroller';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
    <meta name="docbuild:last-update" content="Dec 22, 2023"/>
  </head>


  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">



  <a class="skip-link" href="#main-content">Skip to main content</a>

  <div id="pst-scroll-pixel-helper"></div>


  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>


  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>

  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>

  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>


  <div class="bd-header-announcement container-fluid bd-header-announcement">
    <div class="bd-header-announcement__content"><p>Jobflow Remote is still in beta phase. The API may change at any time.</p></div>
  </div>


    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>


  <div class="col-lg-3 navbar-header-items__start">

      <div class="navbar-item">



<a class="navbar-brand logo" href="../../../index.html">






    <p class="title logo__title">Jobflow Remote v0.0.1 Manual</p>

</a></div>

  </div>

  <div class="col-lg-9 navbar-header-items">

    <div class="me-auto navbar-header-items__center">

        <div class="navbar-item">
<nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../user/index.html">
                        User Guide
                      </a>
                    </li>


                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../api/index.html">
                        API reference
                      </a>
                    </li>


                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../dev/index.html">
                        Development
                      </a>
                    </li>

  </ul>
</nav></div>

    </div>


    <div class="navbar-header-items__end">

        <div class="navbar-item navbar-persistent--container">


 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>


        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>

    </div>

  </div>


    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>



</div>

    </nav>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">

      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">



  <div class="sidebar-header-items sidebar-primary__section">


      <div class="sidebar-header-items__center">

          <div class="navbar-item">
<nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../user/index.html">
                        User Guide
                      </a>
                    </li>


                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../api/index.html">
                        API reference
                      </a>
                    </li>


                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../dev/index.html">
                        Development
                      </a>
                    </li>

  </ul>
</nav></div>

      </div>



      <div class="sidebar-header-items__end">

          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>

      </div>

  </div>


  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>

  <div id="rtd-footer-container"></div>


      </div>

      <main id="main-content" class="bd-main">


          <div class="bd-content">
            <div class="bd-article-container">

              <div class="bd-header-article">
<div class="header-article-items header-article__inner">

    <div class="header-article-items__start">

        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">

    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>

    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>

    <li class="breadcrumb-item active" aria-current="page">jobflow_remo...</li>
  </ul>
</nav>
</div>

    </div>


</div>
</div>




<div id="searchbox"></div>
                <article class="bd-article" role="main">

  <h1>Source code for jobflow_remote.jobs.jobcontroller</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">ExitStack</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">cast</span>

<span class="kn">import</span> <span class="nn">jobflow</span>
<span class="kn">import</span> <span class="nn">pymongo</span>
<span class="kn">from</span> <span class="nn">jobflow</span> <span class="kn">import</span> <span class="n">JobStore</span><span class="p">,</span> <span class="n">OnMissing</span>
<span class="kn">from</span> <span class="nn">maggma.stores</span> <span class="kn">import</span> <span class="n">MongoStore</span>
<span class="kn">from</span> <span class="nn">monty.json</span> <span class="kn">import</span> <span class="n">MontyDecoder</span>
<span class="kn">from</span> <span class="nn">monty.serialization</span> <span class="kn">import</span> <span class="n">loadfn</span>
<span class="kn">from</span> <span class="nn">qtoolkit.core.data_objects</span> <span class="kn">import</span> <span class="n">CancelStatus</span><span class="p">,</span> <span class="n">QResources</span>

<span class="kn">from</span> <span class="nn">jobflow_remote.config.base</span> <span class="kn">import</span> <span class="n">ConfigError</span><span class="p">,</span> <span class="n">ExecutionConfig</span><span class="p">,</span> <span class="n">Project</span>
<span class="kn">from</span> <span class="nn">jobflow_remote.config.manager</span> <span class="kn">import</span> <span class="n">ConfigManager</span>
<span class="kn">from</span> <span class="nn">jobflow_remote.jobs.data</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OUT_FILENAME</span><span class="p">,</span>
    <span class="n">DynamicResponseType</span><span class="p">,</span>
    <span class="n">FlowDoc</span><span class="p">,</span>
    <span class="n">FlowInfo</span><span class="p">,</span>
    <span class="n">JobDoc</span><span class="p">,</span>
    <span class="n">JobInfo</span><span class="p">,</span>
    <span class="n">RemoteError</span><span class="p">,</span>
    <span class="n">get_initial_flow_doc_dict</span><span class="p">,</span>
    <span class="n">get_initial_job_doc_dict</span><span class="p">,</span>
    <span class="n">get_reset_job_base_dict</span><span class="p">,</span>
    <span class="n">projection_job_info</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">jobflow_remote.jobs.state</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">PAUSABLE_STATES</span><span class="p">,</span>
    <span class="n">RESETTABLE_STATES</span><span class="p">,</span>
    <span class="n">RUNNING_STATES</span><span class="p">,</span>
    <span class="n">FlowState</span><span class="p">,</span>
    <span class="n">JobState</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">jobflow_remote.remote.data</span> <span class="kn">import</span> <span class="n">get_remote_store</span><span class="p">,</span> <span class="n">update_store</span>
<span class="kn">from</span> <span class="nn">jobflow_remote.remote.queue</span> <span class="kn">import</span> <span class="n">QueueManager</span>
<span class="kn">from</span> <span class="nn">jobflow_remote.utils.data</span> <span class="kn">import</span> <span class="n">deep_merge_dict</span>
<span class="kn">from</span> <span class="nn">jobflow_remote.utils.db</span> <span class="kn">import</span> <span class="n">FlowLockedError</span><span class="p">,</span> <span class="n">JobLockedError</span><span class="p">,</span> <span class="n">MongoLock</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Generator</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="JobController">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController">[docs]</a>
<span class="k">class</span> <span class="nc">JobController</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main entry point for all the interactions with the Stores.</span>

<span class="sd">    Maintains a connection to both the queue Store and the results JobStore.</span>
<span class="sd">    It is required that the queue Store is a MongoStore, as it will access</span>
<span class="sd">    the database, and work with different collections.</span>

<span class="sd">    The main functionalities are those for updating the state of the database</span>
<span class="sd">    and querying the Jobs and Flows status information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">queue_store</span><span class="p">:</span> <span class="n">MongoStore</span><span class="p">,</span>
        <span class="n">jobstore</span><span class="p">:</span> <span class="n">JobStore</span><span class="p">,</span>
        <span class="n">flows_collection</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;flows&quot;</span><span class="p">,</span>
        <span class="n">auxiliary_collection</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;jf_auxiliary&quot;</span><span class="p">,</span>
        <span class="n">project</span><span class="p">:</span> <span class="n">Project</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        queue_store</span>
<span class="sd">            The Store used to save information about the status of the Jobs.</span>
<span class="sd">            Should be a MongoStore and other collections are used from the same</span>
<span class="sd">            database.</span>
<span class="sd">        jobstore</span>
<span class="sd">            The JobStore containing the output of the jobflow Flows.</span>
<span class="sd">        flows_collection</span>
<span class="sd">            The name of the collection used to store the Flows data.</span>
<span class="sd">            Uses the DB defined in the queue_store.</span>
<span class="sd">        auxiliary_collection</span>
<span class="sd">            The name of the collection used to store other auxiliary data.</span>
<span class="sd">            Uses the DB defined in the queue_store.</span>
<span class="sd">        project</span>
<span class="sd">            The project where the Stores were defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_store</span> <span class="o">=</span> <span class="n">queue_store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobstore</span> <span class="o">=</span> <span class="n">jobstore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobs_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_store</span><span class="o">.</span><span class="n">collection_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flows_collection</span> <span class="o">=</span> <span class="n">flows_collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_collection</span> <span class="o">=</span> <span class="n">auxiliary_collection</span>
        <span class="c1"># TODO should it connect here? Or the passed stores should be connected?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_store</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobstore</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_store</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_store</span><span class="o">.</span><span class="n">_collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">flows_collection</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">auxiliary_collection</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>

<div class="viewcode-block" id="JobController.from_project_name">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.from_project_name">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_project_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JobController</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate an instance of JobController from the project name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        project_name</span>
<span class="sd">            The name of the project. If None the default project will be used.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        JobController</span>
<span class="sd">            An instance of JobController associated with the project.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config_manager</span><span class="p">:</span> <span class="n">ConfigManager</span> <span class="o">=</span> <span class="n">ConfigManager</span><span class="p">()</span>
        <span class="n">project</span><span class="p">:</span> <span class="n">Project</span> <span class="o">=</span> <span class="n">config_manager</span><span class="o">.</span><span class="n">get_project</span><span class="p">(</span><span class="n">project_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_project</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobController.from_project">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.from_project">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_project</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="n">Project</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JobController</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate an instance of JobController from a Project object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        project</span>
<span class="sd">            The project used to generate the JobController. If None the default</span>
<span class="sd">            project will be used.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        JobController</span>
<span class="sd">            An instance of JobController associated with the project.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_store</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">get_queue_store</span><span class="p">()</span>
        <span class="n">flows_collection</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">flows_collection</span>
        <span class="n">auxiliary_collection</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">auxiliary_collection</span>
        <span class="n">jobstore</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">get_jobstore</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">queue_store</span><span class="o">=</span><span class="n">queue_store</span><span class="p">,</span>
            <span class="n">jobstore</span><span class="o">=</span><span class="n">jobstore</span><span class="p">,</span>
            <span class="n">flows_collection</span><span class="o">=</span><span class="n">flows_collection</span><span class="p">,</span>
            <span class="n">auxiliary_collection</span><span class="o">=</span><span class="n">auxiliary_collection</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="JobController.close">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.close">[docs]</a>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close the connections to all the Stores in JobController.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue_store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Error while closing the connection to the queue store&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobstore</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Error while closing the connection to the job store&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_build_query_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">JobState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">locked</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a query to search for Jobs, based on standard parameters.</span>
<span class="sd">        The Jobs will need to satisfy all the defined conditions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_ids</span>
<span class="sd">            One or more tuples, each containing the (uuid, index) pair of the</span>
<span class="sd">            Jobs to retrieve.</span>
<span class="sd">        db_ids</span>
<span class="sd">            One or more db_ids of the Jobs to retrieve.</span>
<span class="sd">        flow_ids</span>
<span class="sd">            One or more Flow uuids to which the Jobs to retrieve belong.</span>
<span class="sd">        state</span>
<span class="sd">            The state of the Jobs.</span>
<span class="sd">        locked</span>
<span class="sd">            If True only locked Jobs will be selected.</span>
<span class="sd">        start_date</span>
<span class="sd">            Filter Jobs that were updated_on after this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        end_date</span>
<span class="sd">            Filter Jobs that were updated_on before this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        name</span>
<span class="sd">            Pattern matching the name of Job. Default is an exact match, but all</span>
<span class="sd">            conventions from python fnmatch can be used (e.g. *test*)</span>
<span class="sd">        metadata</span>
<span class="sd">            A dictionary of the values of the metadata to match. Should be an</span>
<span class="sd">            exact match for all the values provided.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary with the query to be applied to a collection</span>
<span class="sd">            containing JobDocs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ji</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="k">for</span> <span class="n">ji</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">):</span>
            <span class="c1"># without these cast mypy is confused about the type</span>
            <span class="n">job_ids</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="p">[</span><span class="n">job_ids</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">db_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">db_ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">db_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">db_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">flow_ids</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flow_ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">flow_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">flow_ids</span><span class="p">]</span>

        <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">db_ids</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;db_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">db_ids</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">job_ids</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">job_ids</span><span class="p">)</span>
            <span class="n">or_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_index</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">or_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">job_index</span><span class="p">})</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;$or&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">or_list</span>

        <span class="k">if</span> <span class="n">flow_ids</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;hosts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">flow_ids</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">value</span>

        <span class="k">if</span> <span class="n">start_date</span><span class="p">:</span>
            <span class="n">start_date_str</span> <span class="o">=</span> <span class="n">start_date</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;updated_on&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$gte&quot;</span><span class="p">:</span> <span class="n">start_date_str</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">end_date</span><span class="p">:</span>
            <span class="n">end_date_str</span> <span class="o">=</span> <span class="n">end_date</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;updated_on&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$lte&quot;</span><span class="p">:</span> <span class="n">end_date_str</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">locked</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;lock_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$ne&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="c1"># Add the beginning of the line, so that it will match the string</span>
            <span class="c1"># exactly if no wildcard is given. Otherwise will match substrings.</span>
            <span class="n">mongo_regex</span> <span class="o">=</span> <span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$regex&quot;</span><span class="p">:</span> <span class="n">mongo_regex</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">metadata_dict</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;metadata.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">query</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">_build_query_flow</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">FlowState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">locked</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a query to search for Flows, based on standard parameters.</span>
<span class="sd">        The Flows will need to satisfy all the defined conditions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_ids</span>
<span class="sd">            One or more strings with uuids of Jobs belonging to the Flow.</span>
<span class="sd">        db_ids</span>
<span class="sd">            One or more db_ids of Jobs belonging to the Flow.</span>
<span class="sd">        flow_ids</span>
<span class="sd">            One or more Flow uuids.</span>
<span class="sd">        state</span>
<span class="sd">            The state of the Flows.</span>
<span class="sd">        start_date</span>
<span class="sd">            Filter Flows that were updated_on after this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        end_date</span>
<span class="sd">            Filter Flows that were updated_on before this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        name</span>
<span class="sd">            Pattern matching the name of Flow. Default is an exact match, but all</span>
<span class="sd">            conventions from python fnmatch can be used (e.g. *test*)</span>
<span class="sd">        locked</span>
<span class="sd">            If True only locked Flows will be selected.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary with the query to be applied to a collection</span>
<span class="sd">            containing FlowDocs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">db_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">db_ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">db_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">db_ids</span><span class="p">]</span>

        <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">db_ids</span><span class="p">:</span>
            <span class="c1"># the &quot;0&quot; refers to the index in the ids list.</span>
            <span class="c1"># needs to be a string, but is correctly recognized by MongoDB</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$elemMatch&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">db_ids</span><span class="p">}}}</span>
        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">job_ids</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">flow_ids</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">flow_ids</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">value</span>

        <span class="k">if</span> <span class="n">start_date</span><span class="p">:</span>
            <span class="n">start_date_str</span> <span class="o">=</span> <span class="n">start_date</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;updated_on&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$gte&quot;</span><span class="p">:</span> <span class="n">start_date_str</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">end_date</span><span class="p">:</span>
            <span class="n">end_date_str</span> <span class="o">=</span> <span class="n">end_date</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;updated_on&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$lte&quot;</span><span class="p">:</span> <span class="n">end_date_str</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">mongo_regex</span> <span class="o">=</span> <span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$regex&quot;</span><span class="p">:</span> <span class="n">mongo_regex</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">locked</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;lock_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$ne&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">query</span>

<div class="viewcode-block" id="JobController.get_jobs_info_query">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.get_jobs_info_query">[docs]</a>
    <span class="k">def</span> <span class="nf">get_jobs_info_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">JobInfo</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of JobInfo based on a generic query.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        query</span>
<span class="sd">            The query to be performed.</span>
<span class="sd">        kwargs</span>
<span class="sd">            arguments passed to MongoDB find().</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of JobInfo matching the criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection_job_info</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">jobs_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">jobs_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">JobInfo</span><span class="o">.</span><span class="n">from_query_output</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">jobs_data</span></div>


<div class="viewcode-block" id="JobController.get_jobs_info">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.get_jobs_info">[docs]</a>
    <span class="k">def</span> <span class="nf">get_jobs_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">JobState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">locked</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">JobInfo</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query for Jobs based on standard parameters and return a list of JobInfo.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_ids</span>
<span class="sd">            One or more tuples, each containing the (uuid, index) pair of the</span>
<span class="sd">            Jobs to retrieve.</span>
<span class="sd">        db_ids</span>
<span class="sd">            One or more db_ids of the Jobs to retrieve.</span>
<span class="sd">        flow_ids</span>
<span class="sd">            One or more Flow uuids to which the Jobs to retrieve belong.</span>
<span class="sd">        state</span>
<span class="sd">            The state of the Jobs.</span>
<span class="sd">        locked</span>
<span class="sd">            If True only locked Jobs will be selected.</span>
<span class="sd">        start_date</span>
<span class="sd">            Filter Jobs that were updated_on after this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        end_date</span>
<span class="sd">            Filter Jobs that were updated_on before this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        name</span>
<span class="sd">            Pattern matching the name of Job. Default is an exact match, but all</span>
<span class="sd">            conventions from python fnmatch can be used (e.g. *test*)</span>
<span class="sd">        metadata</span>
<span class="sd">            A dictionary of the values of the metadata to match. Should be an</span>
<span class="sd">            exact match for all the values provided.</span>
<span class="sd">        sort</span>
<span class="sd">            A list of (key, direction) pairs specifying the sort order for this</span>
<span class="sd">            query. Follows pymongo conventions.</span>
<span class="sd">        limit</span>
<span class="sd">            Maximum number of entries to retrieve. 0 means no limit.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of JobInfo objects for the Jobs matching the criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_query_job</span><span class="p">(</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">,</span>
            <span class="n">db_ids</span><span class="o">=</span><span class="n">db_ids</span><span class="p">,</span>
            <span class="n">flow_ids</span><span class="o">=</span><span class="n">flow_ids</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="n">locked</span><span class="o">=</span><span class="n">locked</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_jobs_info_query</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobController.get_jobs_doc_query">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.get_jobs_doc_query">[docs]</a>
    <span class="k">def</span> <span class="nf">get_jobs_doc_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">JobDoc</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query for Jobs based on a generic filter and return a list of JobDoc.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        query</span>
<span class="sd">            A dictionary representing the filter.</span>
<span class="sd">        kwargs</span>
<span class="sd">            All arguments passed to pymongo&#39;s Collection.find() method.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of JobDoc objects for the Jobs matching the criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">jobs_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">jobs_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">JobDoc</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">jobs_data</span></div>


<div class="viewcode-block" id="JobController.get_jobs_doc">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.get_jobs_doc">[docs]</a>
    <span class="k">def</span> <span class="nf">get_jobs_doc</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">JobState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">locked</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">JobDoc</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query for Jobs based on standard parameters and return a list of JobDoc.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_ids</span>
<span class="sd">            One or more tuples, each containing the (uuid, index) pair of the</span>
<span class="sd">            Jobs to retrieve.</span>
<span class="sd">        db_ids</span>
<span class="sd">            One or more db_ids of the Jobs to retrieve.</span>
<span class="sd">        flow_ids</span>
<span class="sd">            One or more Flow uuids to which the Jobs to retrieve belong.</span>
<span class="sd">        state</span>
<span class="sd">            The state of the Jobs.</span>
<span class="sd">        locked</span>
<span class="sd">            If True only locked Jobs will be selected.</span>
<span class="sd">        start_date</span>
<span class="sd">            Filter Jobs that were updated_on after this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        end_date</span>
<span class="sd">            Filter Jobs that were updated_on before this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        name</span>
<span class="sd">            Pattern matching the name of Job. Default is an exact match, but all</span>
<span class="sd">            conventions from python fnmatch can be used (e.g. *test*)</span>
<span class="sd">        metadata</span>
<span class="sd">            A dictionary of the values of the metadata to match. Should be an</span>
<span class="sd">            exact match for all the values provided.</span>
<span class="sd">        sort</span>
<span class="sd">            A list of (key, direction) pairs specifying the sort order for this</span>
<span class="sd">            query. Follows pymongo conventions.</span>
<span class="sd">        limit</span>
<span class="sd">            Maximum number of entries to retrieve. 0 means no limit.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of JobDoc objects for the Jobs matching the criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_query_job</span><span class="p">(</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">,</span>
            <span class="n">db_ids</span><span class="o">=</span><span class="n">db_ids</span><span class="p">,</span>
            <span class="n">flow_ids</span><span class="o">=</span><span class="n">flow_ids</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="n">locked</span><span class="o">=</span><span class="n">locked</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_jobs_doc_query</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobController.generate_job_id_query">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.generate_job_id_query">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">generate_job_id_query</span><span class="p">(</span>
        <span class="n">db_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a query for a single Job based on db_id or uuid+index.</span>
<span class="sd">        Only one among db_id and job_id should be defined.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        db_id</span>
<span class="sd">            The db_id of the Job.</span>
<span class="sd">        job_id</span>
<span class="sd">            The uuid of the Job.</span>
<span class="sd">        job_index</span>
<span class="sd">            The index of the Job. If None the Job the sorting will be</span>
<span class="sd">            added to get the highest index.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict, list</span>
<span class="sd">            A dict and an optional list to be used as query and sort,</span>
<span class="sd">            respectively, in a query for a single Job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">job_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">db_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;One and only one among job_id and db_id should be defined&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">db_id</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;db_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_id</span>
        <span class="k">if</span> <span class="n">job_id</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_id</span>
            <span class="k">if</span> <span class="n">job_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># note: this format is suitable for collection.find(sort=.),</span>
                <span class="c1"># but not for $sort in an aggregation.</span>
                <span class="n">sort</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">DESCENDING</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_index</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least one among db_id and job_id should be specified&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span><span class="p">,</span> <span class="n">sort</span></div>


<div class="viewcode-block" id="JobController.get_job_info">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.get_job_info">[docs]</a>
    <span class="k">def</span> <span class="nf">get_job_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JobInfo</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the JobInfo for a single Job based on db_id or uuid+index.</span>
<span class="sd">        Only one among db_id and job_id should be defined.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        db_id</span>
<span class="sd">            The db_id of the Job.</span>
<span class="sd">        job_id</span>
<span class="sd">            The uuid of the Job.</span>
<span class="sd">        job_index</span>
<span class="sd">            The index of the Job. If None the Job with the largest index</span>
<span class="sd">            will be selected.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        JobInfo</span>
<span class="sd">            A JobInfo, or None if no Job matches the criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span><span class="p">,</span> <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_job_id_query</span><span class="p">(</span><span class="n">db_id</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_index</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection_job_info</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">JobInfo</span><span class="o">.</span><span class="n">from_query_output</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


    <span class="k">def</span> <span class="nf">_many_jobs_action</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">action_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">JobState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">method_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method to query Jobs based on criteria and sequentially apply an</span>
<span class="sd">        action on all those retrieved.</span>

<span class="sd">        Used to provide a common interface between all the methods that</span>
<span class="sd">        should be applied on a list of jobs sequentially.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method</span>
<span class="sd">            The function that should be applied on a single Job.</span>
<span class="sd">        action_description</span>
<span class="sd">            A description of the action being performed. For logging purposes.</span>
<span class="sd">        job_ids</span>
<span class="sd">            One or more tuples, each containing the (uuid, index) pair of the</span>
<span class="sd">            Jobs to retrieve.</span>
<span class="sd">        db_ids</span>
<span class="sd">            One or more db_ids of the Jobs to retrieve.</span>
<span class="sd">        flow_ids</span>
<span class="sd">            One or more Flow uuids to which the Jobs to retrieve belong.</span>
<span class="sd">        state</span>
<span class="sd">            The state of the Jobs.</span>
<span class="sd">        locked</span>
<span class="sd">            If True only locked Jobs will be selected.</span>
<span class="sd">        start_date</span>
<span class="sd">            Filter Jobs that were updated_on after this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        end_date</span>
<span class="sd">            Filter Jobs that were updated_on before this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        name</span>
<span class="sd">            Pattern matching the name of Job. Default is an exact match, but all</span>
<span class="sd">            conventions from python fnmatch can be used (e.g. *test*)</span>
<span class="sd">        metadata</span>
<span class="sd">            A dictionary of the values of the metadata to match. Should be an</span>
<span class="sd">            exact match for all the values provided.</span>
<span class="sd">        raise_on_error</span>
<span class="sd">            If True raise in case of error on one job error and stop the loop.</span>
<span class="sd">            Otherwise, just log the error and proceed.</span>
<span class="sd">        method_kwargs</span>
<span class="sd">            Kwargs passed to the method called on each Job</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of db_ids of the updated Jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_query_job</span><span class="p">(</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">,</span>
            <span class="n">db_ids</span><span class="o">=</span><span class="n">db_ids</span><span class="p">,</span>
            <span class="n">flow_ids</span><span class="o">=</span><span class="n">flow_ids</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;db_id&quot;</span><span class="p">])</span>

        <span class="n">queried_dbs_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;db_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>

        <span class="n">updated_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">db_id</span> <span class="ow">in</span> <span class="n">queried_dbs_ids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">job_updated_ids</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">db_id</span><span class="o">=</span><span class="n">db_id</span><span class="p">,</span> <span class="o">**</span><span class="n">method_kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">job_updated_ids</span><span class="p">:</span>
                    <span class="n">updated_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">job_updated_ids</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">raise_on_error</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error while </span><span class="si">{</span><span class="n">action_description</span><span class="si">}</span><span class="s2"> for job </span><span class="si">{</span><span class="n">db_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">updated_ids</span><span class="p">)</span>

<div class="viewcode-block" id="JobController.rerun_jobs">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.rerun_jobs">[docs]</a>
    <span class="k">def</span> <span class="nf">rerun_jobs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">JobState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">break_lock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rerun a list of selected Jobs, i.e. bring their state back to READY.</span>
<span class="sd">        See the docs of `rerun_job` for more details.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_ids</span>
<span class="sd">            One or more tuples, each containing the (uuid, index) pair of the</span>
<span class="sd">            Jobs to retrieve.</span>
<span class="sd">        db_ids</span>
<span class="sd">            One or more db_ids of the Jobs to retrieve.</span>
<span class="sd">        flow_ids</span>
<span class="sd">            One or more Flow uuids to which the Jobs to retrieve belong.</span>
<span class="sd">        state</span>
<span class="sd">            The state of the Jobs.</span>
<span class="sd">        start_date</span>
<span class="sd">            Filter Jobs that were updated_on after this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        end_date</span>
<span class="sd">            Filter Jobs that were updated_on before this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        name</span>
<span class="sd">            Pattern matching the name of Job. Default is an exact match, but all</span>
<span class="sd">            conventions from python fnmatch can be used (e.g. *test*)</span>
<span class="sd">        metadata</span>
<span class="sd">            A dictionary of the values of the metadata to match. Should be an</span>
<span class="sd">            exact match for all the values provided.</span>
<span class="sd">        raise_on_error</span>
<span class="sd">            If True raise in case of error on one job error and stop the loop.</span>
<span class="sd">            Otherwise, just log the error and proceed.</span>
<span class="sd">        force</span>
<span class="sd">            Bypass the limitation that only failed Jobs can be rerun.</span>
<span class="sd">        wait</span>
<span class="sd">            In case the Flow or Jobs that need to be updated are locked,</span>
<span class="sd">            wait this time (in seconds) for the lock to be released.</span>
<span class="sd">            Raise an error if lock is not released.</span>
<span class="sd">        break_lock</span>
<span class="sd">            Forcibly break the lock on locked documents. Use with care and</span>
<span class="sd">            verify that the lock has been set by a process that is not running</span>
<span class="sd">            anymore. Doing otherwise will likely lead to inconsistencies in the DB.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of db_ids of the updated Jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_many_jobs_action</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rerun_job</span><span class="p">,</span>
            <span class="n">action_description</span><span class="o">=</span><span class="s2">&quot;rerunning&quot;</span><span class="p">,</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">,</span>
            <span class="n">db_ids</span><span class="o">=</span><span class="n">db_ids</span><span class="p">,</span>
            <span class="n">flow_ids</span><span class="o">=</span><span class="n">flow_ids</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="n">raise_on_error</span><span class="o">=</span><span class="n">raise_on_error</span><span class="p">,</span>
            <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span>
            <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
            <span class="n">break_lock</span><span class="o">=</span><span class="n">break_lock</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="JobController.rerun_job">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.rerun_job">[docs]</a>
    <span class="k">def</span> <span class="nf">rerun_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">break_lock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rerun a single Job, i.e. bring its state back to READY.</span>
<span class="sd">        Selected by db_id or uuid+index. Only one among db_id</span>
<span class="sd">        and job_id should be defined.</span>

<span class="sd">        By default, only Jobs in one of the running states (CHECKED_OUT,</span>
<span class="sd">        UPLOADED, ...), in the REMOTE_ERROR state or FAILED with</span>
<span class="sd">        children in the READY or WAITING state can be rerun.</span>
<span class="sd">        This should guarantee that no unexpected inconsistencies due to</span>
<span class="sd">        dynamic Jobs generation should appear. This limitation can be bypassed</span>
<span class="sd">        with the `force` option.</span>
<span class="sd">        In any case, no Job with children with index &gt; 1 can be rerun, as there</span>
<span class="sd">        is no sensible way of handling it.</span>

<span class="sd">        Rerunning a Job in a REMOTE_ERROR or on an intermediate STATE also</span>
<span class="sd">        results in a reset of the remote attempts and errors.</span>
<span class="sd">        When rerunning a Job in a SUBMITTED or RUNNING state the system also</span>
<span class="sd">        tries to cancel the process in the worker.</span>
<span class="sd">        Rerunning a FAILED Job also lead to change of state in its children.</span>
<span class="sd">        The full list of modified Jobs is returned.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        db_id</span>
<span class="sd">            The db_id of the Job.</span>
<span class="sd">        job_id</span>
<span class="sd">            The uuid of the Job.</span>
<span class="sd">        job_index</span>
<span class="sd">            The index of the Job. If None: the Job with the highest index.</span>
<span class="sd">        force</span>
<span class="sd">            Bypass the limitation that only Jobs in a certain state can be rerun.</span>
<span class="sd">        wait</span>
<span class="sd">            In case the Flow or Jobs that need to be updated are locked,</span>
<span class="sd">            wait this time (in seconds) for the lock to be released.</span>
<span class="sd">            Raise an error if lock is not released.</span>
<span class="sd">        break_lock</span>
<span class="sd">            Forcibly break the lock on locked documents. Use with care and</span>
<span class="sd">            verify that the lock has been set by a process that is not running</span>
<span class="sd">            anymore. Doing otherwise will likely lead to inconsistencies in the DB.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of db_ids of the updated Jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lock_filter</span><span class="p">,</span> <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_job_id_query</span><span class="p">(</span><span class="n">db_id</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_index</span><span class="p">)</span>
        <span class="n">sleep</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="n">sleep</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="n">modified_jobs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># the job to rerun is the last to be released since this prevents</span>
        <span class="c1"># a checkout of the job while the flow is still locked</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_job</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">lock_filter</span><span class="p">,</span>
            <span class="n">break_lock</span><span class="o">=</span><span class="n">break_lock</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">projection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;db_id&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">],</span>
            <span class="n">sleep</span><span class="o">=</span><span class="n">sleep</span><span class="p">,</span>
            <span class="n">max_wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
            <span class="n">get_locked_doc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">job_lock</span><span class="p">:</span>
            <span class="n">job_doc_dict</span> <span class="o">=</span> <span class="n">job_lock</span><span class="o">.</span><span class="n">locked_document</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job_doc_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">job_lock</span><span class="o">.</span><span class="n">unavailable_document</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">JobLockedError</span><span class="o">.</span><span class="n">from_job_doc</span><span class="p">(</span><span class="n">job_lock</span><span class="o">.</span><span class="n">unavailable_document</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No Job document matching criteria </span><span class="si">{</span><span class="n">lock_filter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">job_state</span> <span class="o">=</span> <span class="n">JobState</span><span class="p">(</span><span class="n">job_doc_dict</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">job_state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">JobState</span><span class="o">.</span><span class="n">READY</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The Job is in the READY state. No need to rerun.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">job_state</span> <span class="ow">in</span> <span class="n">RESETTABLE_STATES</span><span class="p">:</span>
                <span class="c1"># if in one of the resettable states no need to lock the flow or</span>
                <span class="c1"># update children.</span>
                <span class="n">doc_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_remote</span><span class="p">(</span><span class="n">job_doc_dict</span><span class="p">)</span>
                <span class="n">modified_jobs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">job_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">JobState</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">JobState</span><span class="o">.</span><span class="n">REMOTE_ERROR</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Job in state </span><span class="si">{</span><span class="n">job_doc_dict</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> cannot be rerun. &quot;</span>
                    <span class="s2">&quot;Use the &#39;force&#39; option to override this check.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># full restart required</span>
                <span class="n">doc_update</span><span class="p">,</span> <span class="n">modified_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_full_rerun</span><span class="p">(</span>
                    <span class="n">job_doc_dict</span><span class="p">,</span>
                    <span class="n">sleep</span><span class="o">=</span><span class="n">sleep</span><span class="p">,</span>
                    <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
                    <span class="n">break_lock</span><span class="o">=</span><span class="n">break_lock</span><span class="p">,</span>
                    <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">modified_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_doc_dict</span><span class="p">[</span><span class="s2">&quot;db_id&quot;</span><span class="p">])</span>

            <span class="n">set_doc</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="n">doc_update</span><span class="p">}</span>
            <span class="n">job_lock</span><span class="o">.</span><span class="n">update_on_release</span> <span class="o">=</span> <span class="n">set_doc</span>

        <span class="k">return</span> <span class="n">modified_jobs</span></div>


    <span class="k">def</span> <span class="nf">_full_rerun</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">doc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">sleep</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">break_lock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the full rerun of Job, in case a Job is FAILED or in one of the</span>
<span class="sd">        usually not admissible states. This requires actions on the original</span>
<span class="sd">        Job&#39;s children and will need to acquire the lock on all of them as well</span>
<span class="sd">        as on the Flow.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        doc</span>
<span class="sd">            The dict of the JobDoc associated to the Job to rerun.</span>
<span class="sd">            Just the &quot;uuid&quot;, &quot;index&quot;, &quot;db_id&quot;, &quot;state&quot; values are required.</span>
<span class="sd">        sleep</span>
<span class="sd">            Amounts of seconds to wait between checks that the lock has been released.</span>
<span class="sd">        wait</span>
<span class="sd">            In case the Flow or Jobs that need to be updated are locked,</span>
<span class="sd">            wait this time (in seconds) for the lock to be released.</span>
<span class="sd">            Raise an error if lock is not released.</span>
<span class="sd">        break_lock</span>
<span class="sd">            Forcibly break the lock on locked documents.</span>
<span class="sd">        force</span>
<span class="sd">            Bypass the limitation that only Jobs in a certain state can be rerun.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict, list</span>
<span class="sd">            Updates to be set on the rerun Job upon lock release and the list</span>
<span class="sd">            of db_ids of the modified Jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span>
        <span class="n">job_index</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
        <span class="n">modified_jobs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">flow_filter</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;jobs&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">}</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_flow</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">flow_filter</span><span class="p">,</span>
            <span class="n">sleep</span><span class="o">=</span><span class="n">sleep</span><span class="p">,</span>
            <span class="n">max_wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
            <span class="n">get_locked_doc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">break_lock</span><span class="o">=</span><span class="n">break_lock</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">flow_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">flow_lock</span><span class="o">.</span><span class="n">locked_document</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">flow_lock</span><span class="o">.</span><span class="n">unavailable_document</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FlowLockedError</span><span class="o">.</span><span class="n">from_flow_doc</span><span class="p">(</span><span class="n">flow_lock</span><span class="o">.</span><span class="n">unavailable_document</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No Flow document matching criteria </span><span class="si">{</span><span class="n">flow_filter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">flow_doc</span> <span class="o">=</span> <span class="n">FlowDoc</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">flow_lock</span><span class="o">.</span><span class="n">locked_document</span><span class="p">)</span>

            <span class="c1"># only the job with the largest index currently present in the db</span>
            <span class="c1"># can be rerun to avoid inconsistencies. (rerunning a smaller index</span>
            <span class="c1"># would still leave the job with larger indexes in the DB with no</span>
            <span class="c1"># clear way of how to deal with them)</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">flow_doc</span><span class="o">.</span><span class="n">ids_mapping</span><span class="p">[</span><span class="n">job_id</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">job_index</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> is not the highest index (</span><span class="si">{</span><span class="n">job_index</span><span class="si">}</span><span class="s2">). &quot;</span>
                    <span class="s2">&quot;Rerunning it will lead to inconsistencies and is not allowed.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># check that the all the children only those with the largest index</span>
            <span class="c1"># in the flow are present.</span>
            <span class="c1"># If that is the case the rerun would lead to inconsistencies.</span>
            <span class="c1"># If only the last one is among the children it is acceptable</span>
            <span class="c1"># to rerun, but in case of a child with lower index a dynamical</span>
            <span class="c1"># action that cannot be reverted has been already applied.</span>
            <span class="c1"># Do not allow this even if force==True.</span>
            <span class="c1"># if not force, only the first level children need to be checked</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
                <span class="n">descendants</span> <span class="o">=</span> <span class="n">flow_doc</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">descendants</span> <span class="o">=</span> <span class="n">flow_doc</span><span class="o">.</span><span class="n">descendants</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dep_id</span><span class="p">,</span> <span class="n">dep_index</span> <span class="ow">in</span> <span class="n">descendants</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">flow_doc</span><span class="o">.</span><span class="n">ids_mapping</span><span class="p">[</span><span class="n">dep_id</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">dep_index</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> has a child job (</span><span class="si">{</span><span class="n">dep_id</span><span class="si">}</span><span class="s2">) which is not the last index (</span><span class="si">{</span><span class="n">dep_index</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="s2">&quot;Rerunning the Job will lead to inconsistencies and is not allowed.&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># TODO should STOPPED be acceptable?</span>
            <span class="n">acceptable_child_states</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">JobState</span><span class="o">.</span><span class="n">READY</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">JobState</span><span class="o">.</span><span class="n">WAITING</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">JobState</span><span class="o">.</span><span class="n">PAUSED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="c1"># Update the state of the descendants</span>
            <span class="k">with</span> <span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
                <span class="c1"># first acquire the lock on all the descendants and</span>
                <span class="c1"># check their state if needed. Break immediately if</span>
                <span class="c1"># the lock cannot be acquired on one of the children</span>
                <span class="c1"># or if the states do not satisfy the requirements</span>
                <span class="n">children_locks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">dep_id</span><span class="p">,</span> <span class="n">dep_index</span> <span class="ow">in</span> <span class="n">descendants</span><span class="p">:</span>
                    <span class="c1"># TODO consider using the db_id for the query. may be faster?</span>
                    <span class="n">child_lock</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">lock_job</span><span class="p">(</span>
                            <span class="nb">filter</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="n">dep_id</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">dep_index</span><span class="p">},</span>
                            <span class="n">break_lock</span><span class="o">=</span><span class="n">break_lock</span><span class="p">,</span>
                            <span class="n">projection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;db_id&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">],</span>
                            <span class="n">sleep</span><span class="o">=</span><span class="n">sleep</span><span class="p">,</span>
                            <span class="n">max_wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
                            <span class="n">get_locked_doc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">child_doc_dict</span> <span class="o">=</span> <span class="n">child_lock</span><span class="o">.</span><span class="n">locked_document</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">child_doc_dict</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">child_lock</span><span class="o">.</span><span class="n">unavailable_document</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">JobLockedError</span><span class="o">.</span><span class="n">from_job_doc</span><span class="p">(</span>
                                <span class="n">child_lock</span><span class="o">.</span><span class="n">unavailable_document</span><span class="p">,</span>
                                <span class="sa">f</span><span class="s2">&quot;The parent Job with uuid </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> cannot be rerun&quot;</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The child of Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> to rerun with uuid </span><span class="si">{</span><span class="n">dep_id</span><span class="si">}</span><span class="s2"> and index </span><span class="si">{</span><span class="n">dep_index</span><span class="si">}</span><span class="s2"> could not be found in the database&quot;</span>
                        <span class="p">)</span>

                    <span class="c1"># check that the children have not been started yet.</span>
                    <span class="c1"># the only case being if some children allow failed parents.</span>
                    <span class="c1"># Put a lock on each of the children, so that if they are READY</span>
                    <span class="c1"># they will not be checked out</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="ow">not</span> <span class="n">force</span>
                        <span class="ow">and</span> <span class="n">child_doc_dict</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acceptable_child_states</span>
                    <span class="p">):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The child of Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> to rerun with uuid </span><span class="si">{</span><span class="n">dep_id</span><span class="si">}</span><span class="s2"> and &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;index </span><span class="si">{</span><span class="n">dep_index</span><span class="si">}</span><span class="s2"> has state </span><span class="si">{</span><span class="n">child_doc_dict</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> which &quot;</span>
                            <span class="s2">&quot;is not acceptable. Use the &#39;force&#39; option to override this check.&quot;</span>
                        <span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">children_locks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child_lock</span><span class="p">)</span>

                <span class="c1"># Here all the descendants are locked and could be set to WAITING.</span>
                <span class="c1"># Set the new state for all of them.</span>
                <span class="k">for</span> <span class="n">child_lock</span> <span class="ow">in</span> <span class="n">children_locks</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">child_lock</span><span class="o">.</span><span class="n">locked_document</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">JobState</span><span class="o">.</span><span class="n">WAITING</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                        <span class="n">modified_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child_lock</span><span class="o">.</span><span class="n">locked_document</span><span class="p">[</span><span class="s2">&quot;db_id&quot;</span><span class="p">])</span>
                    <span class="n">child_doc_update</span> <span class="o">=</span> <span class="n">get_reset_job_base_dict</span><span class="p">()</span>
                    <span class="n">child_doc_update</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">JobState</span><span class="o">.</span><span class="n">WAITING</span><span class="o">.</span><span class="n">value</span>
                    <span class="n">child_lock</span><span class="o">.</span><span class="n">update_on_release</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="n">child_doc_update</span><span class="p">}</span>

            <span class="c1"># if everything is fine here, update the state of the flow</span>
            <span class="c1"># before releasing its lock and set the update for the original job</span>
            <span class="c1"># pass explicitly the new state of the job, since it is not updated</span>
            <span class="c1"># in the DB. The Job is the last lock to be released.</span>
            <span class="n">updated_states</span> <span class="o">=</span> <span class="p">{</span><span class="n">job_id</span><span class="p">:</span> <span class="p">{</span><span class="n">job_index</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">READY</span><span class="p">}}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_flow_state</span><span class="p">(</span>
                <span class="n">flow_uuid</span><span class="o">=</span><span class="n">flow_doc</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">updated_states</span><span class="o">=</span><span class="n">updated_states</span>
            <span class="p">)</span>

            <span class="n">job_doc_update</span> <span class="o">=</span> <span class="n">get_reset_job_base_dict</span><span class="p">()</span>
            <span class="n">job_doc_update</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">JobState</span><span class="o">.</span><span class="n">READY</span><span class="o">.</span><span class="n">value</span>

        <span class="k">return</span> <span class="n">job_doc_update</span><span class="p">,</span> <span class="n">modified_jobs</span>

    <span class="k">def</span> <span class="nf">_reset_remote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simple reset of a Job in a running state or REMOTE_ERROR.</span>
<span class="sd">        Does not require additional locking on the Flow or other Jobs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        doc</span>
<span class="sd">            The dict of the JobDoc associated to the Job to rerun.</span>
<span class="sd">            Just the &quot;uuid&quot;, &quot;index&quot;, &quot;state&quot; values are required.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Updates to be set on the Job upon lock release.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">JobState</span><span class="o">.</span><span class="n">SUBMITTED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">JobState</span><span class="o">.</span><span class="n">RUNNING</span><span class="o">.</span><span class="n">value</span><span class="p">]:</span>
            <span class="c1"># try cancelling the job submitted to the remote queue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_queue_process</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed cancelling the process for Job </span><span class="si">{</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">job_doc_update</span> <span class="o">=</span> <span class="n">get_reset_job_base_dict</span><span class="p">()</span>
        <span class="n">job_doc_update</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">JobState</span><span class="o">.</span><span class="n">CHECKED_OUT</span><span class="o">.</span><span class="n">value</span>

        <span class="k">return</span> <span class="n">job_doc_update</span>

    <span class="k">def</span> <span class="nf">_set_job_properties</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">db_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">break_lock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">acceptable_states</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">JobState</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper to set multiple values in a JobDoc while locking the Job.</span>
<span class="sd">        Selected by db_id or uuid+index. Only one among db_id</span>
<span class="sd">        and job_id should be defined.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        values</span>
<span class="sd">            Dictionary with the values to be set. Will be passed to a pymongo</span>
<span class="sd">            `find_one_and_update` method.</span>
<span class="sd">        db_id</span>
<span class="sd">            The db_id of the Job.</span>
<span class="sd">        job_id</span>
<span class="sd">            The uuid of the Job.</span>
<span class="sd">        job_index</span>
<span class="sd">            The index of the Job. If None the Job with the largest index</span>
<span class="sd">            will be selected.</span>
<span class="sd">        wait</span>
<span class="sd">            In case the Flow or Jobs that need to be updated are locked,</span>
<span class="sd">            wait this time (in seconds) for the lock to be released.</span>
<span class="sd">            Raise an error if lock is not released.</span>
<span class="sd">        break_lock</span>
<span class="sd">            Forcibly break the lock on locked documents.</span>
<span class="sd">        acceptable_states</span>
<span class="sd">            List of JobState for which the Job values can be changed.</span>
<span class="sd">            If None all states are acceptable.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of db_ids of updated Jobs. Could be an empty list or a list</span>
<span class="sd">            with a single element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sleep</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="n">sleep</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">lock_filter</span><span class="p">,</span> <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_job_id_query</span><span class="p">(</span><span class="n">db_id</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_index</span><span class="p">)</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;db_id&quot;</span><span class="p">,</span> <span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_job</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">lock_filter</span><span class="p">,</span>
            <span class="n">break_lock</span><span class="o">=</span><span class="n">break_lock</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">sleep</span><span class="o">=</span><span class="n">sleep</span><span class="p">,</span>
            <span class="n">max_wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
            <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="n">locked_document</span>
            <span class="k">if</span> <span class="n">doc</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">acceptable_states</span>
                    <span class="ow">and</span> <span class="n">JobState</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acceptable_states</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Job in state </span><span class="si">{</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. The action cannot be performed&quot;</span>
                    <span class="p">)</span>
                <span class="n">values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                <span class="c1"># values[&quot;updated_on&quot;] = datetime.utcnow()</span>
                <span class="n">lock</span><span class="o">.</span><span class="n">update_on_release</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="n">values</span><span class="p">}</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;db_id&quot;</span><span class="p">]]</span>

        <span class="k">return</span> <span class="p">[]</span>

<div class="viewcode-block" id="JobController.set_job_state">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.set_job_state">[docs]</a>
    <span class="k">def</span> <span class="nf">set_job_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">JobState</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">break_lock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the state of a Job to an arbitrary JobState.</span>
<span class="sd">        Selected by db_id or uuid+index. Only one among db_id</span>
<span class="sd">        and job_id should be defined.</span>

<span class="sd">        No check is performed! Any job can be set to any state.</span>
<span class="sd">        Only for advanced users or for debugging purposes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        db_id</span>
<span class="sd">            The db_id of the Job.</span>
<span class="sd">        job_id</span>
<span class="sd">            The uuid of the Job.</span>
<span class="sd">        job_index</span>
<span class="sd">            The index of the Job. If None the Job with the largest index</span>
<span class="sd">            will be selected.</span>
<span class="sd">        wait</span>
<span class="sd">            In case the Flow or Jobs that need to be updated are locked,</span>
<span class="sd">            wait this time (in seconds) for the lock to be released.</span>
<span class="sd">            Raise an error if lock is not released.</span>
<span class="sd">        break_lock</span>
<span class="sd">            Forcibly break the lock on locked documents.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of db_ids of updated Jobs. Could be an empty list or a list</span>
<span class="sd">            with a single element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s2">&quot;remote.step_attempts&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;remote.retry_time_limit&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;previous_state&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;remote.queue_state&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;remote.error&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_job_properties</span><span class="p">(</span>
            <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
            <span class="n">db_id</span><span class="o">=</span><span class="n">db_id</span><span class="p">,</span>
            <span class="n">job_index</span><span class="o">=</span><span class="n">job_index</span><span class="p">,</span>
            <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
            <span class="n">break_lock</span><span class="o">=</span><span class="n">break_lock</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="JobController.retry_jobs">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.retry_jobs">[docs]</a>
    <span class="k">def</span> <span class="nf">retry_jobs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">JobState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">break_lock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retry selected Jobs, i.e. bring them back to its previous state if REMOTE_ERROR,</span>
<span class="sd">        or reset the remote attempts and time of retry if in another running state.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_ids</span>
<span class="sd">            One or more tuples, each containing the (uuid, index) pair of the</span>
<span class="sd">            Jobs to retrieve.</span>
<span class="sd">        db_ids</span>
<span class="sd">            One or more db_ids of the Jobs to retrieve.</span>
<span class="sd">        flow_ids</span>
<span class="sd">            One or more Flow uuids to which the Jobs to retrieve belong.</span>
<span class="sd">        state</span>
<span class="sd">            The state of the Jobs.</span>
<span class="sd">        start_date</span>
<span class="sd">            Filter Jobs that were updated_on after this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        end_date</span>
<span class="sd">            Filter Jobs that were updated_on before this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        name</span>
<span class="sd">            Pattern matching the name of Job. Default is an exact match, but all</span>
<span class="sd">            conventions from python fnmatch can be used (e.g. *test*)</span>
<span class="sd">        metadata</span>
<span class="sd">            A dictionary of the values of the metadata to match. Should be an</span>
<span class="sd">            exact match for all the values provided.</span>
<span class="sd">        raise_on_error</span>
<span class="sd">            If True raise in case of error on one job error and stop the loop.</span>
<span class="sd">            Otherwise, just log the error and proceed.</span>
<span class="sd">        wait</span>
<span class="sd">            In case the Flow or Jobs that need to be updated are locked,</span>
<span class="sd">            wait this time (in seconds) for the lock to be released.</span>
<span class="sd">            Raise an error if lock is not released.</span>
<span class="sd">        break_lock</span>
<span class="sd">            Forcibly break the lock on locked documents. Use with care and</span>
<span class="sd">            verify that the lock has been set by a process that is not running</span>
<span class="sd">            anymore. Doing otherwise will likely lead to inconsistencies in the DB.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of db_ids of the updated Jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_many_jobs_action</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_job</span><span class="p">,</span>
            <span class="n">action_description</span><span class="o">=</span><span class="s2">&quot;rerunning&quot;</span><span class="p">,</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">,</span>
            <span class="n">db_ids</span><span class="o">=</span><span class="n">db_ids</span><span class="p">,</span>
            <span class="n">flow_ids</span><span class="o">=</span><span class="n">flow_ids</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="n">raise_on_error</span><span class="o">=</span><span class="n">raise_on_error</span><span class="p">,</span>
            <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
            <span class="n">break_lock</span><span class="o">=</span><span class="n">break_lock</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="JobController.retry_job">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.retry_job">[docs]</a>
    <span class="k">def</span> <span class="nf">retry_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">break_lock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retry a single Job, i.e. bring it back to its previous state if REMOTE_ERROR,</span>
<span class="sd">        or reset the remote attempts and time of retry if in another running state.</span>
<span class="sd">        Jobs in other states cannot be retried.</span>
<span class="sd">        The Job is selected by db_id or uuid+index. Only one among db_id</span>
<span class="sd">        and job_id should be defined.</span>

<span class="sd">        Only locking of the retried Job is required.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        db_id</span>
<span class="sd">            The db_id of the Job.</span>
<span class="sd">        job_id</span>
<span class="sd">            The uuid of the Job.</span>
<span class="sd">        job_index</span>
<span class="sd">            The index of the Job. If None: the Job with the highest index.</span>
<span class="sd">        wait</span>
<span class="sd">            In case the Flow or Jobs that need to be updated are locked,</span>
<span class="sd">            wait this time (in seconds) for the lock to be released.</span>
<span class="sd">            Raise an error if lock is not released.</span>
<span class="sd">        break_lock</span>
<span class="sd">            Forcibly break the lock on locked documents. Use with care and</span>
<span class="sd">            verify that the lock has been set by a process that is not running</span>
<span class="sd">            anymore. Doing otherwise will likely lead to inconsistencies in the DB.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List containing the db_id of the updated Job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lock_filter</span><span class="p">,</span> <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_job_id_query</span><span class="p">(</span><span class="n">db_id</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_index</span><span class="p">)</span>
        <span class="n">sleep</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="n">sleep</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_job</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">lock_filter</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">get_locked_doc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">sleep</span><span class="o">=</span><span class="n">sleep</span><span class="p">,</span>
            <span class="n">max_wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
            <span class="n">break_lock</span><span class="o">=</span><span class="n">break_lock</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="n">locked_document</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lock</span><span class="o">.</span><span class="n">unavailable_document</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">JobLockedError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The Job matching criteria </span><span class="si">{</span><span class="n">lock_filter</span><span class="si">}</span><span class="s2"> is locked.&quot;</span>
                    <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No Job matching criteria </span><span class="si">{</span><span class="n">lock_filter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">JobState</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">JobState</span><span class="o">.</span><span class="n">REMOTE_ERROR</span><span class="p">:</span>
                <span class="n">previous_state</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;previous_state&quot;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">JobState</span><span class="p">(</span><span class="n">previous_state</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The registered previous state: </span><span class="si">{</span><span class="n">previous_state</span><span class="si">}</span><span class="s2"> is not a valid state&quot;</span>
                    <span class="p">)</span>
                <span class="n">set_dict</span> <span class="o">=</span> <span class="n">get_reset_job_base_dict</span><span class="p">()</span>
                <span class="n">set_dict</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_state</span>

                <span class="n">lock</span><span class="o">.</span><span class="n">update_on_release</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="n">set_dict</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">RUNNING_STATES</span><span class="p">:</span>
                <span class="n">set_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;remote.step_attempts&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;remote.retry_time_limit&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;remote.error&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">lock</span><span class="o">.</span><span class="n">update_on_release</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="n">set_dict</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job in state </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> cannot be retried.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;db_id&quot;</span><span class="p">]]</span></div>


<div class="viewcode-block" id="JobController.pause_jobs">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.pause_jobs">[docs]</a>
    <span class="k">def</span> <span class="nf">pause_jobs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">JobState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pause selected Jobs. Only READY and WAITING Jobs can be paused.</span>
<span class="sd">        The action is reversible.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_ids</span>
<span class="sd">            One or more tuples, each containing the (uuid, index) pair of the</span>
<span class="sd">            Jobs to retrieve.</span>
<span class="sd">        db_ids</span>
<span class="sd">            One or more db_ids of the Jobs to retrieve.</span>
<span class="sd">        flow_ids</span>
<span class="sd">            One or more Flow uuids to which the Jobs to retrieve belong.</span>
<span class="sd">        state</span>
<span class="sd">            The state of the Jobs.</span>
<span class="sd">        start_date</span>
<span class="sd">            Filter Jobs that were updated_on after this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        end_date</span>
<span class="sd">            Filter Jobs that were updated_on before this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        name</span>
<span class="sd">            Pattern matching the name of Job. Default is an exact match, but all</span>
<span class="sd">            conventions from python fnmatch can be used (e.g. *test*)</span>
<span class="sd">        metadata</span>
<span class="sd">            A dictionary of the values of the metadata to match. Should be an</span>
<span class="sd">            exact match for all the values provided.</span>
<span class="sd">        raise_on_error</span>
<span class="sd">            If True raise in case of error on one job error and stop the loop.</span>
<span class="sd">            Otherwise, just log the error and proceed.</span>
<span class="sd">        wait</span>
<span class="sd">            In case the Flow or Jobs that need to be updated are locked,</span>
<span class="sd">            wait this time (in seconds) for the lock to be released.</span>
<span class="sd">            Raise an error if lock is not released.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of db_ids of the updated Jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_many_jobs_action</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pause_job</span><span class="p">,</span>
            <span class="n">action_description</span><span class="o">=</span><span class="s2">&quot;pausing&quot;</span><span class="p">,</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">,</span>
            <span class="n">db_ids</span><span class="o">=</span><span class="n">db_ids</span><span class="p">,</span>
            <span class="n">flow_ids</span><span class="o">=</span><span class="n">flow_ids</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="n">raise_on_error</span><span class="o">=</span><span class="n">raise_on_error</span><span class="p">,</span>
            <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="JobController.stop_jobs">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.stop_jobs">[docs]</a>
    <span class="k">def</span> <span class="nf">stop_jobs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">JobState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">break_lock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop selected Jobs. Only Jobs in the READY and all the running states</span>
<span class="sd">        can be stopped.</span>
<span class="sd">        The action is not reversible.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_ids</span>
<span class="sd">            One or more tuples, each containing the (uuid, index) pair of the</span>
<span class="sd">            Jobs to retrieve.</span>
<span class="sd">        db_ids</span>
<span class="sd">            One or more db_ids of the Jobs to retrieve.</span>
<span class="sd">        flow_ids</span>
<span class="sd">            One or more Flow uuids to which the Jobs to retrieve belong.</span>
<span class="sd">        state</span>
<span class="sd">            The state of the Jobs.</span>
<span class="sd">        start_date</span>
<span class="sd">            Filter Jobs that were updated_on after this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        end_date</span>
<span class="sd">            Filter Jobs that were updated_on before this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        name</span>
<span class="sd">            Pattern matching the name of Job. Default is an exact match, but all</span>
<span class="sd">            conventions from python fnmatch can be used (e.g. *test*)</span>
<span class="sd">        metadata</span>
<span class="sd">            A dictionary of the values of the metadata to match. Should be an</span>
<span class="sd">            exact match for all the values provided.</span>
<span class="sd">        raise_on_error</span>
<span class="sd">            If True raise in case of error on one job error and stop the loop.</span>
<span class="sd">            Otherwise, just log the error and proceed.</span>
<span class="sd">        wait</span>
<span class="sd">            In case the Flow or Jobs that need to be updated are locked,</span>
<span class="sd">            wait this time (in seconds) for the lock to be released.</span>
<span class="sd">            Raise an error if lock is not released.</span>
<span class="sd">        break_lock</span>
<span class="sd">            Forcibly break the lock on locked documents. Use with care and</span>
<span class="sd">            verify that the lock has been set by a process that is not running</span>
<span class="sd">            anymore. Doing otherwise will likely lead to inconsistencies in the DB.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of db_ids of the updated Jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_many_jobs_action</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_job</span><span class="p">,</span>
            <span class="n">action_description</span><span class="o">=</span><span class="s2">&quot;stopping&quot;</span><span class="p">,</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">,</span>
            <span class="n">db_ids</span><span class="o">=</span><span class="n">db_ids</span><span class="p">,</span>
            <span class="n">flow_ids</span><span class="o">=</span><span class="n">flow_ids</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="n">raise_on_error</span><span class="o">=</span><span class="n">raise_on_error</span><span class="p">,</span>
            <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
            <span class="n">break_lock</span><span class="o">=</span><span class="n">break_lock</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="JobController.stop_job">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.stop_job">[docs]</a>
    <span class="k">def</span> <span class="nf">stop_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">break_lock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop a single Job. Only Jobs in the READY and all the running states</span>
<span class="sd">        can be stopped.</span>
<span class="sd">        Selected by db_id or uuid+index. Only one among db_id</span>
<span class="sd">        and job_id should be defined.</span>
<span class="sd">        The action is not reversible.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        db_id</span>
<span class="sd">            The db_id of the Job.</span>
<span class="sd">        job_id</span>
<span class="sd">            The uuid of the Job.</span>
<span class="sd">        job_index</span>
<span class="sd">            The index of the Job. If None: the Job with the highest index.</span>
<span class="sd">        wait</span>
<span class="sd">            In case the Flow or Jobs that need to be updated are locked,</span>
<span class="sd">            wait this time (in seconds) for the lock to be released.</span>
<span class="sd">            Raise an error if lock is not released.</span>
<span class="sd">        break_lock</span>
<span class="sd">            Forcibly break the lock on locked documents. Use with care and</span>
<span class="sd">            verify that the lock has been set by a process that is not running</span>
<span class="sd">            anymore. Doing otherwise will likely lead to inconsistencies in the DB.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of db_ids of the updated Jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">job_lock_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">projection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;db_id&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;remote&quot;</span><span class="p">,</span> <span class="s2">&quot;worker&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">flow_lock_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_job_flow</span><span class="p">(</span>
            <span class="n">acceptable_states</span><span class="o">=</span><span class="p">[</span><span class="n">JobState</span><span class="o">.</span><span class="n">READY</span><span class="p">]</span> <span class="o">+</span> <span class="n">RUNNING_STATES</span><span class="p">,</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
            <span class="n">db_id</span><span class="o">=</span><span class="n">db_id</span><span class="p">,</span>
            <span class="n">job_index</span><span class="o">=</span><span class="n">job_index</span><span class="p">,</span>
            <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
            <span class="n">break_lock</span><span class="o">=</span><span class="n">break_lock</span><span class="p">,</span>
            <span class="n">job_lock_kwargs</span><span class="o">=</span><span class="n">job_lock_kwargs</span><span class="p">,</span>
            <span class="n">flow_lock_kwargs</span><span class="o">=</span><span class="n">flow_lock_kwargs</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">job_lock</span><span class="p">,</span> <span class="n">flow_lock</span><span class="p">):</span>
            <span class="n">job_doc</span> <span class="o">=</span> <span class="n">job_lock</span><span class="o">.</span><span class="n">locked_document</span>
            <span class="n">job_state</span> <span class="o">=</span> <span class="n">JobState</span><span class="p">(</span><span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">job_state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">JobState</span><span class="o">.</span><span class="n">SUBMITTED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">JobState</span><span class="o">.</span><span class="n">RUNNING</span><span class="o">.</span><span class="n">value</span><span class="p">]:</span>
                <span class="c1"># try cancelling the job submitted to the remote queue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_queue_process</span><span class="p">(</span><span class="n">job_doc</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed cancelling the process for Job </span><span class="si">{</span><span class="n">job_doc</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">job_doc</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span>
            <span class="n">job_index</span> <span class="o">=</span> <span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
            <span class="n">updated_states</span> <span class="o">=</span> <span class="p">{</span><span class="n">job_id</span><span class="p">:</span> <span class="p">{</span><span class="n">job_index</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">USER_STOPPED</span><span class="p">}}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_flow_state</span><span class="p">(</span>
                <span class="n">flow_uuid</span><span class="o">=</span><span class="n">flow_lock</span><span class="o">.</span><span class="n">locked_document</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">],</span>
                <span class="n">updated_states</span><span class="o">=</span><span class="n">updated_states</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">job_lock</span><span class="o">.</span><span class="n">update_on_release</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">USER_STOPPED</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">job_lock</span><span class="o">.</span><span class="n">locked_document</span><span class="p">[</span><span class="s2">&quot;db_id&quot;</span><span class="p">]]</span></div>


<div class="viewcode-block" id="JobController.pause_job">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.pause_job">[docs]</a>
    <span class="k">def</span> <span class="nf">pause_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pause a single Job. Only READY and WAITING Jobs can be paused.</span>
<span class="sd">        Selected by db_id or uuid+index. Only one among db_id</span>
<span class="sd">        and job_id should be defined.</span>
<span class="sd">        The action is reversible.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        db_id</span>
<span class="sd">            The db_id of the Job.</span>
<span class="sd">        job_id</span>
<span class="sd">            The uuid of the Job.</span>
<span class="sd">        job_index</span>
<span class="sd">            The index of the Job. If None: the Job with the highest index.</span>
<span class="sd">        wait</span>
<span class="sd">            In case the Flow or Jobs that need to be updated are locked,</span>
<span class="sd">            wait this time (in seconds) for the lock to be released.</span>
<span class="sd">            Raise an error if lock is not released.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of db_ids of the updated Jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">job_lock_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;db_id&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">])</span>
        <span class="n">flow_lock_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_job_flow</span><span class="p">(</span>
            <span class="n">acceptable_states</span><span class="o">=</span><span class="n">PAUSABLE_STATES</span><span class="p">,</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
            <span class="n">db_id</span><span class="o">=</span><span class="n">db_id</span><span class="p">,</span>
            <span class="n">job_index</span><span class="o">=</span><span class="n">job_index</span><span class="p">,</span>
            <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
            <span class="n">break_lock</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">job_lock_kwargs</span><span class="o">=</span><span class="n">job_lock_kwargs</span><span class="p">,</span>
            <span class="n">flow_lock_kwargs</span><span class="o">=</span><span class="n">flow_lock_kwargs</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">job_lock</span><span class="p">,</span> <span class="n">flow_lock</span><span class="p">):</span>
            <span class="n">job_doc</span> <span class="o">=</span> <span class="n">job_lock</span><span class="o">.</span><span class="n">locked_document</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span>
            <span class="n">job_index</span> <span class="o">=</span> <span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
            <span class="n">updated_states</span> <span class="o">=</span> <span class="p">{</span><span class="n">job_id</span><span class="p">:</span> <span class="p">{</span><span class="n">job_index</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">}}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_flow_state</span><span class="p">(</span>
                <span class="n">flow_uuid</span><span class="o">=</span><span class="n">flow_lock</span><span class="o">.</span><span class="n">locked_document</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">],</span>
                <span class="n">updated_states</span><span class="o">=</span><span class="n">updated_states</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">job_lock</span><span class="o">.</span><span class="n">update_on_release</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">PAUSED</span><span class="o">.</span><span class="n">value</span><span class="p">}}</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">job_lock</span><span class="o">.</span><span class="n">locked_document</span><span class="p">[</span><span class="s2">&quot;db_id&quot;</span><span class="p">]]</span></div>


<div class="viewcode-block" id="JobController.play_jobs">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.play_jobs">[docs]</a>
    <span class="k">def</span> <span class="nf">play_jobs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">JobState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">break_lock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restart selected Jobs that were previously paused.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_ids</span>
<span class="sd">            One or more tuples, each containing the (uuid, index) pair of the</span>
<span class="sd">            Jobs to retrieve.</span>
<span class="sd">        db_ids</span>
<span class="sd">            One or more db_ids of the Jobs to retrieve.</span>
<span class="sd">        flow_ids</span>
<span class="sd">            One or more Flow uuids to which the Jobs to retrieve belong.</span>
<span class="sd">        state</span>
<span class="sd">            The state of the Jobs.</span>
<span class="sd">        start_date</span>
<span class="sd">            Filter Jobs that were updated_on after this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        end_date</span>
<span class="sd">            Filter Jobs that were updated_on before this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        name</span>
<span class="sd">            Pattern matching the name of Job. Default is an exact match, but all</span>
<span class="sd">            conventions from python fnmatch can be used (e.g. *test*)</span>
<span class="sd">        metadata</span>
<span class="sd">            A dictionary of the values of the metadata to match. Should be an</span>
<span class="sd">            exact match for all the values provided.</span>
<span class="sd">        raise_on_error</span>
<span class="sd">            If True raise in case of error on one job error and stop the loop.</span>
<span class="sd">            Otherwise, just log the error and proceed.</span>
<span class="sd">        wait</span>
<span class="sd">            In case the Flow or Jobs that need to be updated are locked,</span>
<span class="sd">            wait this time (in seconds) for the lock to be released.</span>
<span class="sd">            Raise an error if lock is not released.</span>
<span class="sd">        break_lock</span>
<span class="sd">            Forcibly break the lock on locked documents. Use with care and</span>
<span class="sd">            verify that the lock has been set by a process that is not running</span>
<span class="sd">            anymore. Doing otherwise will likely lead to inconsistencies in the DB.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of db_ids of the updated Jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_many_jobs_action</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">play_job</span><span class="p">,</span>
            <span class="n">action_description</span><span class="o">=</span><span class="s2">&quot;playing&quot;</span><span class="p">,</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">,</span>
            <span class="n">db_ids</span><span class="o">=</span><span class="n">db_ids</span><span class="p">,</span>
            <span class="n">flow_ids</span><span class="o">=</span><span class="n">flow_ids</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="n">raise_on_error</span><span class="o">=</span><span class="n">raise_on_error</span><span class="p">,</span>
            <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
            <span class="n">break_lock</span><span class="o">=</span><span class="n">break_lock</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="JobController.play_job">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.play_job">[docs]</a>
    <span class="k">def</span> <span class="nf">play_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">break_lock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restart a single Jobs that was previously paused.</span>
<span class="sd">        Selected by db_id or uuid+index. Only one among db_id</span>
<span class="sd">        and job_id should be defined.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        db_id</span>
<span class="sd">            The db_id of the Job.</span>
<span class="sd">        job_id</span>
<span class="sd">            The uuid of the Job.</span>
<span class="sd">        job_index</span>
<span class="sd">            The index of the Job. If None: the Job with the highest index.</span>
<span class="sd">        wait</span>
<span class="sd">            In case the Flow or Jobs that need to be updated are locked,</span>
<span class="sd">            wait this time (in seconds) for the lock to be released.</span>
<span class="sd">            Raise an error if lock is not released.</span>
<span class="sd">        break_lock</span>
<span class="sd">            Forcibly break the lock on locked documents. Use with care and</span>
<span class="sd">            verify that the lock has been set by a process that is not running</span>
<span class="sd">            anymore. Doing otherwise will likely lead to inconsistencies in the DB.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of db_ids of the updated Jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">job_lock_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">projection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;db_id&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;job.config&quot;</span><span class="p">,</span> <span class="s2">&quot;parents&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">flow_lock_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_job_flow</span><span class="p">(</span>
            <span class="n">acceptable_states</span><span class="o">=</span><span class="p">[</span><span class="n">JobState</span><span class="o">.</span><span class="n">PAUSED</span><span class="p">],</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
            <span class="n">db_id</span><span class="o">=</span><span class="n">db_id</span><span class="p">,</span>
            <span class="n">job_index</span><span class="o">=</span><span class="n">job_index</span><span class="p">,</span>
            <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
            <span class="n">break_lock</span><span class="o">=</span><span class="n">break_lock</span><span class="p">,</span>
            <span class="n">job_lock_kwargs</span><span class="o">=</span><span class="n">job_lock_kwargs</span><span class="p">,</span>
            <span class="n">flow_lock_kwargs</span><span class="o">=</span><span class="n">flow_lock_kwargs</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">job_lock</span><span class="p">,</span> <span class="n">flow_lock</span><span class="p">):</span>
            <span class="n">job_doc</span> <span class="o">=</span> <span class="n">job_lock</span><span class="o">.</span><span class="n">locked_document</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span>
            <span class="n">job_index</span> <span class="o">=</span> <span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
            <span class="n">on_missing</span> <span class="o">=</span> <span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;job&quot;</span><span class="p">][</span><span class="s2">&quot;config&quot;</span><span class="p">][</span><span class="s2">&quot;on_missing_references&quot;</span><span class="p">]</span>
            <span class="n">allow_failed</span> <span class="o">=</span> <span class="n">on_missing</span> <span class="o">!=</span> <span class="n">OnMissing</span><span class="o">.</span><span class="n">ERROR</span><span class="o">.</span><span class="n">value</span>

            <span class="c1"># in principle the lock on each of the parent jobs is not needed</span>
            <span class="c1"># since a parent Job cannot change to COMPLETED or FAILED while</span>
            <span class="c1"># the flow is locked</span>
            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;parents&quot;</span><span class="p">]}},</span> <span class="n">projection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">parent_state</span> <span class="o">=</span> <span class="n">JobState</span><span class="p">(</span><span class="n">parent</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">parent_state</span> <span class="o">!=</span> <span class="n">JobState</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">parent_state</span> <span class="o">==</span> <span class="n">JobState</span><span class="o">.</span><span class="n">FAILED</span> <span class="ow">and</span> <span class="n">allow_failed</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">final_state</span> <span class="o">=</span> <span class="n">JobState</span><span class="o">.</span><span class="n">WAITING</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">final_state</span> <span class="o">=</span> <span class="n">JobState</span><span class="o">.</span><span class="n">READY</span>

            <span class="n">updated_states</span> <span class="o">=</span> <span class="p">{</span><span class="n">job_id</span><span class="p">:</span> <span class="p">{</span><span class="n">job_index</span><span class="p">:</span> <span class="n">final_state</span><span class="p">}}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_flow_state</span><span class="p">(</span>
                <span class="n">flow_uuid</span><span class="o">=</span><span class="n">flow_lock</span><span class="o">.</span><span class="n">locked_document</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">],</span>
                <span class="n">updated_states</span><span class="o">=</span><span class="n">updated_states</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">job_lock</span><span class="o">.</span><span class="n">update_on_release</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">final_state</span><span class="o">.</span><span class="n">value</span><span class="p">}}</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">job_lock</span><span class="o">.</span><span class="n">locked_document</span><span class="p">[</span><span class="s2">&quot;db_id&quot;</span><span class="p">]]</span></div>


<div class="viewcode-block" id="JobController.set_job_run_properties">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.set_job_run_properties">[docs]</a>
    <span class="k">def</span> <span class="nf">set_job_run_properties</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">worker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exec_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">ExecutionConfig</span> <span class="o">|</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resources</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">QResources</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">JobState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set execution properties for selected Jobs:</span>
<span class="sd">        worker, exec_config and resources.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        worker</span>
<span class="sd">            The name of the worker to set.</span>
<span class="sd">        exec_config</span>
<span class="sd">            The name of the exec_config to set or an explicit value of</span>
<span class="sd">            ExecutionConfig or dict.</span>
<span class="sd">        resources</span>
<span class="sd">            The resources to be set, either as a dict or a QResources instance.</span>
<span class="sd">        update</span>
<span class="sd">            If True, when setting exec_config and resources a passed dictionary</span>
<span class="sd">            will be used to update already existing values.</span>
<span class="sd">            If False it will replace the original values.</span>
<span class="sd">        job_ids</span>
<span class="sd">            One or more tuples, each containing the (uuid, index) pair of the</span>
<span class="sd">            Jobs to retrieve.</span>
<span class="sd">        db_ids</span>
<span class="sd">            One or more db_ids of the Jobs to retrieve.</span>
<span class="sd">        flow_ids</span>
<span class="sd">            One or more Flow uuids to which the Jobs to retrieve belong.</span>
<span class="sd">        state</span>
<span class="sd">            The state of the Jobs.</span>
<span class="sd">        start_date</span>
<span class="sd">            Filter Jobs that were updated_on after this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        end_date</span>
<span class="sd">            Filter Jobs that were updated_on before this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        name</span>
<span class="sd">            Pattern matching the name of Job. Default is an exact match, but all</span>
<span class="sd">            conventions from python fnmatch can be used (e.g. *test*)</span>
<span class="sd">        metadata</span>
<span class="sd">            A dictionary of the values of the metadata to match. Should be an</span>
<span class="sd">            exact match for all the values provided.</span>
<span class="sd">        raise_on_error</span>
<span class="sd">            If True raise in case of error on one job error and stop the loop.</span>
<span class="sd">            Otherwise, just log the error and proceed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of db_ids of the updated Jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">set_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">worker</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">worker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;worker </span><span class="si">{</span><span class="n">worker</span><span class="si">}</span><span class="s2"> is not present in the project&quot;</span><span class="p">)</span>
            <span class="n">set_dict</span><span class="p">[</span><span class="s2">&quot;worker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">worker</span>

        <span class="k">if</span> <span class="n">exec_config</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">exec_config</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">exec_config</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">exec_config</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;exec_config </span><span class="si">{</span><span class="n">exec_config</span><span class="si">}</span><span class="s2"> is not present in the project&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exec_config</span><span class="p">,</span> <span class="n">ExecutionConfig</span><span class="p">):</span>
                <span class="n">exec_config</span> <span class="o">=</span> <span class="n">exec_config</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">update</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exec_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">exec_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">set_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;exec_config.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">set_dict</span><span class="p">[</span><span class="s2">&quot;exec_config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exec_config</span>

        <span class="k">if</span> <span class="n">resources</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resources</span><span class="p">,</span> <span class="n">QResources</span><span class="p">):</span>
                <span class="n">resources</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">resources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">set_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;resources.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">set_dict</span><span class="p">[</span><span class="s2">&quot;resources&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resources</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_many_jobs_action</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_job_properties</span><span class="p">,</span>
            <span class="n">action_description</span><span class="o">=</span><span class="s2">&quot;setting&quot;</span><span class="p">,</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">,</span>
            <span class="n">db_ids</span><span class="o">=</span><span class="n">db_ids</span><span class="p">,</span>
            <span class="n">flow_ids</span><span class="o">=</span><span class="n">flow_ids</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="n">raise_on_error</span><span class="o">=</span><span class="n">raise_on_error</span><span class="p">,</span>
            <span class="n">values</span><span class="o">=</span><span class="n">set_dict</span><span class="p">,</span>
            <span class="n">acceptable_states</span><span class="o">=</span><span class="p">[</span><span class="n">JobState</span><span class="o">.</span><span class="n">READY</span><span class="p">,</span> <span class="n">JobState</span><span class="o">.</span><span class="n">WAITING</span><span class="p">],</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="JobController.get_flow_job_aggreg">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.get_flow_job_aggreg">[docs]</a>
    <span class="k">def</span> <span class="nf">get_flow_job_aggreg</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">projection</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve data about Flows and all their Jobs through an aggregation.</span>

<span class="sd">        In the aggregation the list of Jobs are identified as `jobs_list`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        query</span>
<span class="sd">            A dictionary representing the filter.</span>
<span class="sd">        projection</span>
<span class="sd">            Projection of the fields passed to the aggregation.</span>
<span class="sd">        sort</span>
<span class="sd">            A list of (key, direction) pairs specifying the sort order for this</span>
<span class="sd">            query. Follows pymongo conventions.</span>
<span class="sd">        limit</span>
<span class="sd">            Maximum number of entries to retrieve. 0 means no limit.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            The list of dictionaries resulting from the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pipeline</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;$lookup&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs_collection</span><span class="p">,</span>
                    <span class="s2">&quot;localField&quot;</span><span class="p">:</span> <span class="s2">&quot;jobs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;foreignField&quot;</span><span class="p">:</span> <span class="s2">&quot;uuid&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;as&quot;</span><span class="p">:</span> <span class="s2">&quot;jobs_list&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">projection</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="n">projection</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$sort&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sort</span><span class="p">}})</span>

        <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$limit&quot;</span><span class="p">:</span> <span class="n">limit</span><span class="p">})</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">))</span></div>


<div class="viewcode-block" id="JobController.get_flows_info">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.get_flows_info">[docs]</a>
    <span class="k">def</span> <span class="nf">get_flows_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">FlowState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">full</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">FlowInfo</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query for Flows based on standard parameters and return a list of JobFlows.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_ids</span>
<span class="sd">            One or more strings with uuids of Jobs belonging to the Flow.</span>
<span class="sd">        db_ids</span>
<span class="sd">            One or more db_ids of Jobs belonging to the Flow.</span>
<span class="sd">        flow_ids</span>
<span class="sd">            One or more Flow uuids.</span>
<span class="sd">        state</span>
<span class="sd">            The state of the Flows.</span>
<span class="sd">        start_date</span>
<span class="sd">            Filter Flows that were updated_on after this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        end_date</span>
<span class="sd">            Filter Flows that were updated_on before this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        name</span>
<span class="sd">            Pattern matching the name of Flow. Default is an exact match, but all</span>
<span class="sd">            conventions from python fnmatch can be used (e.g. *test*)</span>
<span class="sd">        sort</span>
<span class="sd">            A list of (key, direction) pairs specifying the sort order for this</span>
<span class="sd">            query. Follows pymongo conventions.</span>
<span class="sd">        limit</span>
<span class="sd">            Maximum number of entries to retrieve. 0 means no limit.</span>
<span class="sd">        full</span>
<span class="sd">            If True data is fetched from both the Flow collection and Job collection</span>
<span class="sd">            with an aggregate. Otherwise, only the Job information in the Flow</span>
<span class="sd">            document will be used.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of JobFlows.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_query_flow</span><span class="p">(</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">,</span>
            <span class="n">db_ids</span><span class="o">=</span><span class="n">db_ids</span><span class="p">,</span>
            <span class="n">flow_ids</span><span class="o">=</span><span class="n">flow_ids</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Only use the full aggregation if more job details are needed.</span>
        <span class="c1"># The single flow document is enough for basic information</span>
        <span class="k">if</span> <span class="n">full</span><span class="p">:</span>
            <span class="c1"># TODO reduce the projection to the bare minimum to reduce the amount of</span>
            <span class="c1"># fecthed data?</span>
            <span class="n">projection</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;jobs_list.</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">projection_job_info</span><span class="p">}</span>
            <span class="n">projection</span><span class="p">[</span><span class="s2">&quot;jobs_list.job.hosts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">FlowDoc</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">projection</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_flow_job_aggreg</span><span class="p">(</span>
                <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">))</span>

        <span class="n">jobs_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">jobs_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FlowInfo</span><span class="o">.</span><span class="n">from_query_dict</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">jobs_data</span></div>


<div class="viewcode-block" id="JobController.delete_flows">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.delete_flows">[docs]</a>
    <span class="k">def</span> <span class="nf">delete_flows</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">flow_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">confirm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">delete_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a list of Flows based on the flow uuids.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        flow_ids</span>
<span class="sd">            One or more Flow uuids.</span>
<span class="sd">        confirm</span>
<span class="sd">            If False only a maximum of 10 Flows can be deleted.</span>
<span class="sd">        delete_output</span>
<span class="sd">            If True also delete the associated output in the JobStore.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Number of delete Flows.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flow_ids</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">flow_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">flow_ids</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">flow_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">flow_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">find</span><span class="p">({},</span> <span class="n">projection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">])]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flow_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">confirm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Deleting more than 10 flows requires explicit confirmation&quot;</span>
            <span class="p">)</span>
        <span class="n">deleted</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">fid</span> <span class="ow">in</span> <span class="n">flow_ids</span><span class="p">:</span>
            <span class="c1"># TODO should it catch errors?</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_flow</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">delete_output</span><span class="p">):</span>
                <span class="n">deleted</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">deleted</span></div>


<div class="viewcode-block" id="JobController.delete_flow">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.delete_flow">[docs]</a>
    <span class="k">def</span> <span class="nf">delete_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">delete_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a single Flow based on the uuid.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        flow_id</span>
<span class="sd">            One or more Flow uuids.</span>
<span class="sd">        delete_output</span>
<span class="sd">            If True also delete the associated output in the JobStore.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO should this lock anything (FW does not lock)?</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_flow_info_by_flow_uuid</span><span class="p">(</span><span class="n">flow_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">flow</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">job_ids</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">delete_output</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobstore</span><span class="o">.</span><span class="n">remove_docs</span><span class="p">({</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">job_ids</span><span class="p">}})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">job_ids</span><span class="p">}})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">delete_one</span><span class="p">({</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="n">flow_id</span><span class="p">})</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="JobController.remove_lock_job">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.remove_lock_job">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_lock_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">JobState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forcibly remove the lock on a locked Job document.</span>
<span class="sd">        This should be used only if a lock is a leftover of a process that is not</span>
<span class="sd">        running anymore. Doing otherwise may result in inconsistencies.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_ids</span>
<span class="sd">            One or more tuples, each containing the (uuid, index) pair of the</span>
<span class="sd">            Jobs to retrieve.</span>
<span class="sd">        db_ids</span>
<span class="sd">            One or more db_ids of the Jobs to retrieve.</span>
<span class="sd">        flow_ids</span>
<span class="sd">            One or more Flow uuids to which the Jobs to retrieve belong.</span>
<span class="sd">        state</span>
<span class="sd">            The state of the Jobs.</span>
<span class="sd">        start_date</span>
<span class="sd">            Filter Jobs that were updated_on after this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        end_date</span>
<span class="sd">            Filter Jobs that were updated_on before this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        name</span>
<span class="sd">            Pattern matching the name of Job. Default is an exact match, but all</span>
<span class="sd">            conventions from python fnmatch can be used (e.g. *test*)</span>
<span class="sd">        metadata</span>
<span class="sd">            A dictionary of the values of the metadata to match. Should be an</span>
<span class="sd">            exact match for all the values provided.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Number of modified Jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_query_job</span><span class="p">(</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">,</span>
            <span class="n">db_ids</span><span class="o">=</span><span class="n">db_ids</span><span class="p">,</span>
            <span class="n">flow_ids</span><span class="o">=</span><span class="n">flow_ids</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
            <span class="n">locked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">update_many</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
            <span class="n">update</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;lock_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;lock_time&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}},</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">modified_count</span></div>


<div class="viewcode-block" id="JobController.remove_lock_flow">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.remove_lock_flow">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_lock_flow</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">FlowState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forcibly remove the lock on a locked Flow document.</span>
<span class="sd">        This should be used only if a lock is a leftover of a process that is not</span>
<span class="sd">        running anymore. Doing otherwise may result in inconsistencies.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_ids</span>
<span class="sd">            One or more strings with uuids of Jobs belonging to the Flow.</span>
<span class="sd">        db_ids</span>
<span class="sd">            One or more db_ids of Jobs belonging to the Flow.</span>
<span class="sd">        flow_ids</span>
<span class="sd">            One or more Flow uuids.</span>
<span class="sd">        state</span>
<span class="sd">            The state of the Flows.</span>
<span class="sd">        start_date</span>
<span class="sd">            Filter Flows that were updated_on after this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        end_date</span>
<span class="sd">            Filter Flows that were updated_on before this date.</span>
<span class="sd">            Should be in the machine local time zone. It will be converted to UTC.</span>
<span class="sd">        name</span>
<span class="sd">            Pattern matching the name of Flow. Default is an exact match, but all</span>
<span class="sd">            conventions from python fnmatch can be used (e.g. *test*)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Number of modified Flows.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_query_flow</span><span class="p">(</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">,</span>
            <span class="n">db_ids</span><span class="o">=</span><span class="n">db_ids</span><span class="p">,</span>
            <span class="n">flow_ids</span><span class="o">=</span><span class="n">flow_ids</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
            <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
            <span class="n">locked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">update_many</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
            <span class="n">update</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;lock_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;lock_time&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}},</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">modified_count</span></div>


<div class="viewcode-block" id="JobController.reset">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.reset">[docs]</a>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reset_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">max_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset the content of the queue database and builds the indexes.</span>
<span class="sd">        Optionally deletes the content of the JobStore with the outputs.</span>
<span class="sd">        In this case all the data contained in the JobStore will be removed,</span>
<span class="sd">        not just those associated to the data in the queue.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        reset_output</span>
<span class="sd">            If True also reset the JobStore containing the outputs.</span>
<span class="sd">        max_limit</span>
<span class="sd">            Maximum number of Flows present in the DB. If number is larger</span>
<span class="sd">            the database will not be reset. Set 0 for not limit.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if the database was reset, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO should it just delete docs related to job removed in the reset?</span>
        <span class="c1"># what if the outputs are in other stores? Should take those as well</span>
        <span class="k">if</span> <span class="n">max_limit</span><span class="p">:</span>
            <span class="n">n_flows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">count_documents</span><span class="p">({})</span>
            <span class="k">if</span> <span class="n">n_flows</span> <span class="o">&gt;=</span> <span class="n">max_limit</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The database contains </span><span class="si">{</span><span class="n">n_flows</span><span class="si">}</span><span class="s2"> flows and will not be reset. &quot;</span>
                    <span class="s2">&quot;Increase the max_limit value or set it to 0&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">reset_output</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobstore</span><span class="o">.</span><span class="n">remove_docs</span><span class="p">({})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="s2">&quot;next_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_indexes</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="JobController.build_indexes">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.build_indexes">[docs]</a>
    <span class="k">def</span> <span class="nf">build_indexes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">background</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">job_custom_indexes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_custom_indexes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build indexes in the database</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        background</span>
<span class="sd">            If True, the indexes should be created in the background.</span>
<span class="sd">        job_custom_indexes</span>
<span class="sd">            List of custom indexes for the jobs collection. Each element is passed</span>
<span class="sd">            to pymongo&#39;s create_index, thus following those conventions.</span>
<span class="sd">        flow_custom_indexes</span>
<span class="sd">            List of custom indexes for the flows collection.</span>
<span class="sd">            Same as job_custom_indexes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;db_id&quot;</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">)</span>

        <span class="n">job_indexes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;uuid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;index&quot;</span><span class="p">,</span>
            <span class="s2">&quot;state&quot;</span><span class="p">,</span>
            <span class="s2">&quot;updated_on&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;worker&quot;</span><span class="p">,</span>
            <span class="p">[(</span><span class="s2">&quot;priority&quot;</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">DESCENDING</span><span class="p">)],</span>
            <span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;remote.retry_time_limit&quot;</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job_indexes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job_custom_indexes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">job_custom_indexes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">)</span>

        <span class="n">flow_indexes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;uuid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;state&quot;</span><span class="p">,</span>
            <span class="s2">&quot;updated_on&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ids&quot;</span><span class="p">,</span>
            <span class="s2">&quot;jobs&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">flow_indexes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">flow_custom_indexes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">flow_custom_indexes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobController.compact">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.compact">[docs]</a>
    <span class="k">def</span> <span class="nf">compact</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compact jobs and flows collections in MongoDB.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">command</span><span class="p">({</span><span class="s2">&quot;compact&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs_collection</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">command</span><span class="p">({</span><span class="s2">&quot;compact&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">flows_collection</span><span class="p">})</span></div>


<div class="viewcode-block" id="JobController.get_flow_info_by_flow_uuid">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.get_flow_info_by_flow_uuid">[docs]</a>
    <span class="k">def</span> <span class="nf">get_flow_info_by_flow_uuid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">flow_uuid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">projection</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="n">flow_uuid</span><span class="p">},</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobController.get_flow_info_by_job_uuid">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.get_flow_info_by_job_uuid">[docs]</a>
    <span class="k">def</span> <span class="nf">get_flow_info_by_job_uuid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">job_uuid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">projection</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;jobs&quot;</span><span class="p">:</span> <span class="n">job_uuid</span><span class="p">},</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobController.get_job_info_by_job_uuid">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.get_job_info_by_job_uuid">[docs]</a>
    <span class="k">def</span> <span class="nf">get_job_info_by_job_uuid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_uuid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">job_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;last&quot;</span><span class="p">,</span>
        <span class="n">projection</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="n">job_uuid</span><span class="p">}</span>
        <span class="n">sort</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_index</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_index</span>
        <span class="k">elif</span> <span class="n">job_index</span> <span class="o">==</span> <span class="s2">&quot;last&quot;</span><span class="p">:</span>
            <span class="n">sort</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;job_index value: </span><span class="si">{</span><span class="n">job_index</span><span class="si">}</span><span class="s2"> is not supported&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobController.get_job_doc">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.get_job_doc">[docs]</a>
    <span class="k">def</span> <span class="nf">get_job_doc</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JobDoc</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">query</span><span class="p">,</span> <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_job_id_query</span><span class="p">(</span><span class="n">db_id</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_index</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">JobDoc</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="JobController.get_jobs">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.get_jobs">[docs]</a>
    <span class="k">def</span> <span class="nf">get_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">projection</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">))</span></div>


<div class="viewcode-block" id="JobController.count_jobs">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.count_jobs">[docs]</a>
    <span class="k">def</span> <span class="nf">count_jobs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">JobState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">locked</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">query</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_query_job</span><span class="p">(</span>
                <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">,</span>
                <span class="n">db_ids</span><span class="o">=</span><span class="n">db_ids</span><span class="p">,</span>
                <span class="n">flow_ids</span><span class="o">=</span><span class="n">flow_ids</span><span class="p">,</span>
                <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                <span class="n">locked</span><span class="o">=</span><span class="n">locked</span><span class="p">,</span>
                <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
                <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobController.count_flows">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.count_flows">[docs]</a>
    <span class="k">def</span> <span class="nf">count_flows</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">FlowState</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_query_flow</span><span class="p">(</span>
                <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">,</span>
                <span class="n">db_ids</span><span class="o">=</span><span class="n">db_ids</span><span class="p">,</span>
                <span class="n">flow_ids</span><span class="o">=</span><span class="n">flow_ids</span><span class="p">,</span>
                <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
                <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobController.get_jobs_info_by_flow_uuid">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.get_jobs_info_by_flow_uuid">[docs]</a>
    <span class="k">def</span> <span class="nf">get_jobs_info_by_flow_uuid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">flow_uuid</span><span class="p">,</span> <span class="n">projection</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job.hosts&quot;</span><span class="p">:</span> <span class="n">flow_uuid</span><span class="p">}</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">))</span></div>


    <span class="c1"># TODO exec_config and resources can be removed and taken from the job.</span>
    <span class="c1"># The value could be set in each job by the submit_job or by the user.</span>
    <span class="c1"># Doing the same for the worker? In this way it could be set dynamically</span>
<div class="viewcode-block" id="JobController.add_flow">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.add_flow">[docs]</a>
    <span class="k">def</span> <span class="nf">add_flow</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">flow</span><span class="p">:</span> <span class="n">jobflow</span><span class="o">.</span><span class="n">Flow</span> <span class="o">|</span> <span class="n">jobflow</span><span class="o">.</span><span class="n">Job</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">jobflow</span><span class="o">.</span><span class="n">Job</span><span class="p">],</span>
        <span class="n">worker</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">allow_external_references</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">exec_config</span><span class="p">:</span> <span class="n">ExecutionConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resources</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">QResources</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="kn">from</span> <span class="nn">jobflow.core.flow</span> <span class="kn">import</span> <span class="n">get_flow</span>

        <span class="n">flow</span> <span class="o">=</span> <span class="n">get_flow</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">allow_external_references</span><span class="o">=</span><span class="n">allow_external_references</span><span class="p">)</span>

        <span class="n">jobs_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">iterflow</span><span class="p">())</span>
        <span class="n">job_dicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n_jobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobs_list</span><span class="p">)</span>

        <span class="n">doc_next_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">find_one_and_update</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;next_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}},</span> <span class="p">{</span><span class="s2">&quot;$inc&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;next_id&quot;</span><span class="p">:</span> <span class="n">n_jobs</span><span class="p">}}</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">doc_next_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;It seems that the database has not been initialised. If that is the&quot;</span>
                <span class="s2">&quot; case run `jf admin reset` or use the reset() method of JobController&quot;</span>
            <span class="p">)</span>
        <span class="n">first_id</span> <span class="o">=</span> <span class="n">doc_next_id</span><span class="p">[</span><span class="s2">&quot;next_id&quot;</span><span class="p">]</span>
        <span class="n">db_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">parents</span><span class="p">),</span> <span class="n">db_id_int</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">jobs_list</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">first_id</span><span class="p">,</span> <span class="n">first_id</span> <span class="o">+</span> <span class="n">n_jobs</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">db_id_prefix</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">db_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">db_id_int</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">db_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">db_id</span><span class="p">)</span>
            <span class="n">job_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">get_initial_job_doc_dict</span><span class="p">(</span>
                    <span class="n">job</span><span class="p">,</span>
                    <span class="n">parents</span><span class="p">,</span>
                    <span class="n">db_id</span><span class="p">,</span>
                    <span class="n">worker</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span>
                    <span class="n">exec_config</span><span class="o">=</span><span class="n">exec_config</span><span class="p">,</span>
                    <span class="n">resources</span><span class="o">=</span><span class="n">resources</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">flow_doc</span> <span class="o">=</span> <span class="n">get_initial_flow_doc_dict</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">job_dicts</span><span class="p">)</span>

        <span class="c1"># inserting first the flow document and, iteratively, all the jobs</span>
        <span class="c1"># should not lead to inconsistencies in the states, even if one of</span>
        <span class="c1"># the jobs is checked out in the meanwhile. The opposite could lead</span>
        <span class="c1"># to errors.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">flow_doc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">job_dicts</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added flow (</span><span class="si">{</span><span class="n">flow</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">) with jobs: </span><span class="si">{</span><span class="n">flow</span><span class="o">.</span><span class="n">job_uuids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">db_ids</span></div>


    <span class="k">def</span> <span class="nf">_append_flow</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_doc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">flow_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">new_flow_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">worker</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">response_type</span><span class="p">:</span> <span class="n">DynamicResponseType</span><span class="p">,</span>
        <span class="n">exec_config</span><span class="p">:</span> <span class="n">ExecutionConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resources</span><span class="p">:</span> <span class="n">QResources</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">from</span> <span class="nn">jobflow</span> <span class="kn">import</span> <span class="n">Flow</span><span class="p">,</span> <span class="n">Job</span>

        <span class="n">decoder</span> <span class="o">=</span> <span class="n">MontyDecoder</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">deserialize_partial_flow</span><span class="p">(</span><span class="n">in_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Recursively deserialize a Flow dictionary, avoiding the deserialization</span>
<span class="sd">            of all the elements that may require external packages.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">in_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;@class&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Flow&quot;</span><span class="p">:</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">deserialize_partial_flow</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">in_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;jobs&quot;</span><span class="p">)]</span>
                <span class="n">flow_init</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">in_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;@module&quot;</span><span class="p">,</span> <span class="s2">&quot;@class&quot;</span><span class="p">,</span> <span class="s2">&quot;@version&quot;</span><span class="p">,</span> <span class="s2">&quot;job&quot;</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="n">flow_init</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
                <span class="k">return</span> <span class="n">Flow</span><span class="p">(</span><span class="o">**</span><span class="n">flow_init</span><span class="p">)</span>
            <span class="c1"># if it is not a Flow, should be a Job</span>
            <span class="n">job_init</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">in_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;@module&quot;</span><span class="p">,</span> <span class="s2">&quot;@class&quot;</span><span class="p">,</span> <span class="s2">&quot;@version&quot;</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">job_init</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">job_init</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">Job</span><span class="p">(</span><span class="o">**</span><span class="n">job_init</span><span class="p">)</span>

        <span class="c1"># It is sure that the new_flow_dict is a serialized Flow (and not Job</span>
        <span class="c1"># or list[Job]), because the get_flow has already been applied at run</span>
        <span class="c1"># time, during the remote execution.</span>
        <span class="c1"># Recursive deserialize the Flow without deserializing function and</span>
        <span class="c1"># arguments to take advantage of standard Flow/Job methods.</span>
        <span class="n">new_flow</span> <span class="o">=</span> <span class="n">deserialize_partial_flow</span><span class="p">(</span><span class="n">new_flow_dict</span><span class="p">)</span>

        <span class="c1"># get job parents</span>
        <span class="k">if</span> <span class="n">response_type</span> <span class="o">==</span> <span class="n">DynamicResponseType</span><span class="o">.</span><span class="n">REPLACE</span><span class="p">:</span>
            <span class="n">job_parents</span> <span class="o">=</span> <span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;parents&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job_parents</span> <span class="o">=</span> <span class="p">[(</span><span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">],</span> <span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])]</span>

        <span class="c1"># add new jobs to flow</span>
        <span class="n">flow_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">flow_dict</span><span class="p">)</span>
        <span class="n">flow_updates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;$push&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;jobs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$each&quot;</span><span class="p">:</span> <span class="n">new_flow</span><span class="o">.</span><span class="n">job_uuids</span><span class="p">}}</span>
        <span class="p">}</span>

        <span class="c1"># add new jobs</span>
        <span class="n">jobs_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_flow</span><span class="o">.</span><span class="n">iterflow</span><span class="p">())</span>
        <span class="n">n_new_jobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobs_list</span><span class="p">)</span>
        <span class="n">first_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">find_one_and_update</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;next_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}},</span> <span class="p">{</span><span class="s2">&quot;$inc&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;next_id&quot;</span><span class="p">:</span> <span class="n">n_new_jobs</span><span class="p">}}</span>
        <span class="p">)[</span><span class="s2">&quot;next_id&quot;</span><span class="p">]</span>
        <span class="n">job_dicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">flow_updates</span><span class="p">[</span><span class="s2">&quot;$set&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ids_to_push</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">parents</span><span class="p">),</span> <span class="n">db_id_int</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">jobs_list</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">first_id</span><span class="p">,</span> <span class="n">first_id</span> <span class="o">+</span> <span class="n">n_new_jobs</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">db_id_prefix</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">db_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">db_id_int</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># inherit the parents of the job to which we are appending</span>
            <span class="n">parents</span> <span class="o">=</span> <span class="n">parents</span> <span class="k">if</span> <span class="n">parents</span> <span class="k">else</span> <span class="n">job_parents</span>
            <span class="n">job_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">get_initial_job_doc_dict</span><span class="p">(</span>
                    <span class="n">job</span><span class="p">,</span>
                    <span class="n">parents</span><span class="p">,</span>
                    <span class="n">db_id</span><span class="p">,</span>
                    <span class="n">worker</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span>
                    <span class="n">exec_config</span><span class="o">=</span><span class="n">exec_config</span><span class="p">,</span>
                    <span class="n">resources</span><span class="o">=</span><span class="n">resources</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">flow_updates</span><span class="p">[</span><span class="s2">&quot;$set&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;parents.</span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parents</span>
            <span class="n">ids_to_push</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">job_dicts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;db_id&quot;</span><span class="p">],</span> <span class="n">job</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="n">flow_updates</span><span class="p">[</span><span class="s2">&quot;$push&quot;</span><span class="p">][</span><span class="s2">&quot;ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$each&quot;</span><span class="p">:</span> <span class="n">ids_to_push</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">response_type</span> <span class="o">==</span> <span class="n">DynamicResponseType</span><span class="o">.</span><span class="n">DETOUR</span><span class="p">:</span>
            <span class="c1"># if detour, update the parents of the child jobs</span>
            <span class="n">leaf_uuids</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">new_flow</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">out_degree</span><span class="p">()</span> <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">update_many</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;parents&quot;</span><span class="p">:</span> <span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]},</span>
                <span class="p">{</span><span class="s2">&quot;$push&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;parents&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$each&quot;</span><span class="p">:</span> <span class="n">leaf_uuids</span><span class="p">}}},</span>
            <span class="p">)</span>

        <span class="c1"># flow_dict[&quot;updated_on&quot;] = datetime.utcnow()</span>
        <span class="n">flow_updates</span><span class="p">[</span><span class="s2">&quot;$set&quot;</span><span class="p">][</span><span class="s2">&quot;updated_on&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

        <span class="c1"># TODO, this could be replaced by the actual change, instead of the replace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="n">flow_dict</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]},</span> <span class="n">flow_updates</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">job_dicts</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Appended flow (</span><span class="si">{</span><span class="n">new_flow</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">) with jobs: </span><span class="si">{</span><span class="n">new_flow</span><span class="o">.</span><span class="n">job_uuids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="JobController.checkout_job">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.checkout_job">[docs]</a>
    <span class="k">def</span> <span class="nf">checkout_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_uuid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check out one job.</span>

<span class="sd">        Set the job state from READY to CHECKED_OUT with an atomic update.</span>
<span class="sd">        Flow state is also updated if needed.</span>

<span class="sd">        NB: flow is not locked during the checkout at any time.</span>
<span class="sd">        Does not require lock of the Job document.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># comment on locking: lock during check out may serve two purposes:</span>
        <span class="c1"># 1) update the state of the Flow object. With the conditional set</span>
        <span class="c1">#    this should be fine even without locking</span>
        <span class="c1"># 2) to prevent checking out jobs while other processes may be working</span>
        <span class="c1">#    on the same flow. (e.g. while rerunning a parent of a READY child,</span>
        <span class="c1">#    it would be necessary that the job is not started in the meanwhile).</span>
        <span class="c1">#    Without a full Flow lock this case may show up.</span>
        <span class="c1"># For the time being do not lock the flow and check if issues are arising.</span>

        <span class="n">query</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">query</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">READY</span><span class="o">.</span><span class="n">value</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">flow_uuid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if flow uuid provided, only include job ids in that flow</span>
            <span class="n">job_uuids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_flow_info_by_flow_uuid</span><span class="p">(</span><span class="n">flow_uuid</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">])[</span><span class="s2">&quot;jobs&quot;</span><span class="p">]</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">job_uuids</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">sort</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sort</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;priority&quot;</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">DESCENDING</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;created_on&quot;</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">ASCENDING</span><span class="p">)]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">find_one_and_update</span><span class="p">(</span>
            <span class="n">query</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">CHECKED_OUT</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="s2">&quot;updated_on&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="n">projection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">],</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="c1"># return_document=ReturnDocument.AFTER,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">reserved_uuid</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span>
        <span class="n">reserved_index</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="c1"># update flow state. If it is READY switch its state, otherwise no change</span>
        <span class="c1"># to the state. The operation is atomic.</span>
        <span class="c1"># Filtering on the index is not needed</span>
        <span class="n">state_cond</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;$cond&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;if&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$eq&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;$state&quot;</span><span class="p">,</span> <span class="s2">&quot;READY&quot;</span><span class="p">]},</span>
                <span class="s2">&quot;then&quot;</span><span class="p">:</span> <span class="s2">&quot;RUNNING&quot;</span><span class="p">,</span>
                <span class="s2">&quot;else&quot;</span><span class="p">:</span> <span class="s2">&quot;$state&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">updated_cond</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;$cond&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;if&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$eq&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;$state&quot;</span><span class="p">,</span> <span class="s2">&quot;READY&quot;</span><span class="p">]},</span>
                <span class="s2">&quot;then&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
                <span class="s2">&quot;else&quot;</span><span class="p">:</span> <span class="s2">&quot;$updated_on&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">find_one_and_update</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;jobs&quot;</span><span class="p">:</span> <span class="n">reserved_uuid</span><span class="p">},</span>
            <span class="p">[{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state_cond</span><span class="p">,</span> <span class="s2">&quot;updated_on&quot;</span><span class="p">:</span> <span class="n">updated_cond</span><span class="p">}}],</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">reserved_uuid</span><span class="p">,</span> <span class="n">reserved_index</span></div>


    <span class="c1"># TODO if jobstore is not an option anymore, the &quot;store&quot; argument</span>
    <span class="c1"># can be removed and just use self.jobstore.</span>
<div class="viewcode-block" id="JobController.complete_job">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.complete_job">[docs]</a>
    <span class="k">def</span> <span class="nf">complete_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">job_doc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">local_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">store</span><span class="p">:</span> <span class="n">JobStore</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># Don&#39;t sleep if the flow is locked. Only the Runner should call this,</span>
        <span class="c1"># and it will handle the fact of having a locked Flow.</span>
        <span class="c1"># Lock before reading the data. locks the Flow for a longer time, but</span>
        <span class="c1"># avoids parsing (potentially large) files to discover that the flow is</span>
        <span class="c1"># already locked.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_flow</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;jobs&quot;</span><span class="p">:</span> <span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]},</span> <span class="n">get_locked_doc</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">flow_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">flow_lock</span><span class="o">.</span><span class="n">locked_document</span><span class="p">:</span>
                <span class="n">local_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
                <span class="n">out_path</span> <span class="o">=</span> <span class="n">local_path</span> <span class="o">/</span> <span class="n">OUT_FILENAME</span>
                <span class="n">host_flow_id</span> <span class="o">=</span> <span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;job&quot;</span><span class="p">][</span><span class="s2">&quot;hosts&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">out_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The output file </span><span class="si">{</span><span class="n">OUT_FILENAME</span><span class="si">}</span><span class="s2"> was not present in the download &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;folder </span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2"> and it is required to complete the job&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">checkin_job</span><span class="p">(</span>
                        <span class="n">job_doc</span><span class="p">,</span> <span class="n">flow_lock</span><span class="o">.</span><span class="n">locked_document</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">msg</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_flow_state</span><span class="p">(</span><span class="n">host_flow_id</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>

                <span class="c1"># do not deserialize the response or stored data, saves time and</span>
                <span class="c1"># avoids the need for packages to be installed.</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">loadfn</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">decoder</span> <span class="o">=</span> <span class="n">MontyDecoder</span><span class="p">()</span>
                <span class="n">doc_update</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">decoder</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">])}</span>
                <span class="c1"># update the time of the JobDoc, will be used in the checkin</span>
                <span class="n">end_time</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end_time&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">end_time</span><span class="p">:</span>
                    <span class="n">doc_update</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_time</span>

                <span class="n">error</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">checkin_job</span><span class="p">(</span>
                        <span class="n">job_doc</span><span class="p">,</span>
                        <span class="n">flow_lock</span><span class="o">.</span><span class="n">locked_document</span><span class="p">,</span>
                        <span class="n">response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span>
                        <span class="n">doc_update</span><span class="o">=</span><span class="n">doc_update</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_flow_state</span><span class="p">(</span><span class="n">host_flow_id</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>

                <span class="n">response</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The output file </span><span class="si">{</span><span class="n">OUT_FILENAME</span><span class="si">}</span><span class="s2"> was downloaded, but it does &quot;</span>
                        <span class="s2">&quot;not contain the response. The job was likely killed &quot;</span>
                        <span class="s2">&quot;before completing&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">checkin_job</span><span class="p">(</span>
                        <span class="n">job_doc</span><span class="p">,</span>
                        <span class="n">flow_lock</span><span class="o">.</span><span class="n">locked_document</span><span class="p">,</span>
                        <span class="n">response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">error</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span>
                        <span class="n">doc_update</span><span class="o">=</span><span class="n">doc_update</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_flow_state</span><span class="p">(</span><span class="n">host_flow_id</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>

                <span class="n">remote_store</span> <span class="o">=</span> <span class="n">get_remote_store</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>

                <span class="n">update_store</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">remote_store</span><span class="p">,</span> <span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;db_id&quot;</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">checkin_job</span><span class="p">(</span>
                    <span class="n">job_doc</span><span class="p">,</span>
                    <span class="n">flow_lock</span><span class="o">.</span><span class="n">locked_document</span><span class="p">,</span>
                    <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                    <span class="n">doc_update</span><span class="o">=</span><span class="n">doc_update</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_flow_state</span><span class="p">(</span><span class="n">host_flow_id</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">flow_lock</span><span class="o">.</span><span class="n">unavailable_document</span><span class="p">:</span>
                <span class="c1"># raising the error if the lock could not be acquired leaves</span>
                <span class="c1"># the caller handle the issue. In general, it should be the</span>
                <span class="c1"># runner, that will retry at a later time.</span>
                <span class="k">raise</span> <span class="n">FlowLockedError</span><span class="o">.</span><span class="n">from_flow_doc</span><span class="p">(</span>
                    <span class="n">flow_lock</span><span class="o">.</span><span class="n">unavailable_document</span><span class="p">,</span> <span class="s2">&quot;Could not complete the job&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="JobController.checkin_job">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.checkin_job">[docs]</a>
    <span class="k">def</span> <span class="nf">checkin_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_doc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">flow_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">response</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">error</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">doc_update</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">stored_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_state</span> <span class="o">=</span> <span class="n">JobState</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>
        <span class="c1"># handle response</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_state</span> <span class="o">=</span> <span class="n">JobState</span><span class="o">.</span><span class="n">COMPLETED</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;replace&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_append_flow</span><span class="p">(</span>
                    <span class="n">job_doc</span><span class="p">,</span>
                    <span class="n">flow_dict</span><span class="p">,</span>
                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;replace&quot;</span><span class="p">],</span>
                    <span class="n">response_type</span><span class="o">=</span><span class="n">DynamicResponseType</span><span class="o">.</span><span class="n">REPLACE</span><span class="p">,</span>
                    <span class="n">worker</span><span class="o">=</span><span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;worker&quot;</span><span class="p">],</span>
                    <span class="n">exec_config</span><span class="o">=</span><span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;exec_config&quot;</span><span class="p">],</span>
                    <span class="n">resources</span><span class="o">=</span><span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;resources&quot;</span><span class="p">],</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;addition&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_append_flow</span><span class="p">(</span>
                    <span class="n">job_doc</span><span class="p">,</span>
                    <span class="n">flow_dict</span><span class="p">,</span>
                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;addition&quot;</span><span class="p">],</span>
                    <span class="n">response_type</span><span class="o">=</span><span class="n">DynamicResponseType</span><span class="o">.</span><span class="n">ADDITION</span><span class="p">,</span>
                    <span class="n">worker</span><span class="o">=</span><span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;worker&quot;</span><span class="p">],</span>
                    <span class="n">exec_config</span><span class="o">=</span><span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;exec_config&quot;</span><span class="p">],</span>
                    <span class="n">resources</span><span class="o">=</span><span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;resources&quot;</span><span class="p">],</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;detour&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_append_flow</span><span class="p">(</span>
                    <span class="n">job_doc</span><span class="p">,</span>
                    <span class="n">flow_dict</span><span class="p">,</span>
                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;detour&quot;</span><span class="p">],</span>
                    <span class="n">response_type</span><span class="o">=</span><span class="n">DynamicResponseType</span><span class="o">.</span><span class="n">DETOUR</span><span class="p">,</span>
                    <span class="n">worker</span><span class="o">=</span><span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;worker&quot;</span><span class="p">],</span>
                    <span class="n">exec_config</span><span class="o">=</span><span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;exec_config&quot;</span><span class="p">],</span>
                    <span class="n">resources</span><span class="o">=</span><span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;resources&quot;</span><span class="p">],</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;stored_data&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">stored_data</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;stored_data&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;stop_children&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop_children</span><span class="p">(</span><span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;stop_jobflow&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop_jobflow</span><span class="p">(</span><span class="n">job_uuid</span><span class="o">=</span><span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">doc_update</span><span class="p">:</span>
            <span class="n">doc_update</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">doc_update</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">new_state</span><span class="p">,</span> <span class="s2">&quot;stored_data&quot;</span><span class="p">:</span> <span class="n">stored_data</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">],</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]},</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="n">doc_update</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">modified_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The job </span><span class="si">{</span><span class="n">job_doc</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> index </span><span class="si">{</span><span class="n">job_doc</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> has not been updated in the database&quot;</span>
            <span class="p">)</span>

        <span class="c1"># TODO it should be fine to replace this query by constructing the list of</span>
        <span class="c1"># job uuids from the original + those added. Should be verified.</span>
        <span class="n">job_uuids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_flow_info_by_job_uuid</span><span class="p">(</span><span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">])[</span><span class="s2">&quot;jobs&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refresh_children</span><span class="p">(</span><span class="n">job_uuids</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span></div>


    <span class="c1"># TODO should this refresh all the kind of states? Or just set to ready?</span>
<div class="viewcode-block" id="JobController.refresh_children">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.refresh_children">[docs]</a>
    <span class="k">def</span> <span class="nf">refresh_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_uuids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the state of Jobs children to READY following the completion of a Job.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_uuids</span>
<span class="sd">            List of Jobs uuids belonging to a Flow.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            List of db_ids of modified Jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># go through and look for jobs whose state we can update to ready.</span>
        <span class="c1"># Need to ensure that all parent uuids with all indices are completed</span>
        <span class="c1"># first find state of all jobs; ensure larger indices are returned last.</span>
        <span class="n">flow_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">job_uuids</span><span class="p">}},</span>
            <span class="n">sort</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span>
            <span class="n">projection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;parents&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;job.config&quot;</span><span class="p">,</span> <span class="s2">&quot;db_id&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># the mapping only contains jobs with the larger index</span>
        <span class="n">jobs_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">j</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]:</span> <span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">flow_jobs</span><span class="p">}</span>

        <span class="c1"># Now find jobs that are queued and whose parents are all completed</span>
        <span class="c1"># (or allowed to fail) and ready them. Assume that none of the children</span>
        <span class="c1"># can be in a running state and thus no need to lock them.</span>
        <span class="n">to_ready</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">allowed_states</span> <span class="o">=</span> <span class="p">[</span><span class="n">JobState</span><span class="o">.</span><span class="n">COMPLETED</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
            <span class="n">on_missing_ref</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;job&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;on_missing_references&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">on_missing_ref</span> <span class="o">==</span> <span class="n">jobflow</span><span class="o">.</span><span class="n">OnMissing</span><span class="o">.</span><span class="n">NONE</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">allowed_states</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">JobState</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">JobState</span><span class="o">.</span><span class="n">USER_STOPPED</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">JobState</span><span class="o">.</span><span class="n">WAITING</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
                <span class="p">[</span><span class="n">jobs_mapping</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">allowed_states</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;parents&quot;</span><span class="p">]]</span>
            <span class="p">):</span>
                <span class="c1"># Use the db_id to identify the children, since the uuid alone is not</span>
                <span class="c1"># enough in some cases.</span>
                <span class="n">to_ready</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;db_id&quot;</span><span class="p">])</span>

        <span class="c1"># Here it is assuming that there will be only one job with each uuid, as</span>
        <span class="c1"># it should be when switching state to READY the first time.</span>
        <span class="c1"># The code forbids rerunning a job that have children with index larger than 1,</span>
        <span class="c1"># so this should always be consistent.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_ready</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">update_many</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;db_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">to_ready</span><span class="p">}},</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">READY</span><span class="o">.</span><span class="n">value</span><span class="p">}}</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">to_ready</span></div>


<div class="viewcode-block" id="JobController.stop_children">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.stop_children">[docs]</a>
    <span class="k">def</span> <span class="nf">stop_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_uuid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop the direct children of a Job in the WAITING state.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_uuid</span>
<span class="sd">            The uuid of the Job.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            The number of modified Jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">update_many</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;parents&quot;</span><span class="p">:</span> <span class="n">job_uuid</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">WAITING</span><span class="o">.</span><span class="n">value</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">STOPPED</span><span class="o">.</span><span class="n">value</span><span class="p">}},</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">modified_count</span></div>


<div class="viewcode-block" id="JobController.stop_jobflow">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.stop_jobflow">[docs]</a>
    <span class="k">def</span> <span class="nf">stop_jobflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_uuid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">flow_uuid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop all the WAITING Jobs in a Flow.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_uuid</span>
<span class="sd">            The uuid of Job to identify the Flow. Incompatible with flow_uuid.</span>
<span class="sd">        flow_uuid</span>
<span class="sd">            The Flow uuid. Incompatible with job_uuid.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            The number of modified Jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job_uuid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">flow_uuid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either job_uuid or flow_uuid must be set.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job_uuid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">flow_uuid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only one of job_uuid and flow_uuid should be set.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job_uuid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;jobs&quot;</span><span class="p">:</span> <span class="n">job_uuid</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="n">flow_uuid</span><span class="p">}</span>

        <span class="c1"># get uuids of jobs in the flow</span>
        <span class="n">flow_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">flow_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">job_uuids</span> <span class="o">=</span> <span class="n">flow_dict</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">update_many</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">job_uuids</span><span class="p">},</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">WAITING</span><span class="o">.</span><span class="n">value</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">STOPPED</span><span class="o">.</span><span class="n">value</span><span class="p">}},</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">modified_count</span></div>


<div class="viewcode-block" id="JobController.get_job_uuids">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.get_job_uuids">[docs]</a>
    <span class="k">def</span> <span class="nf">get_job_uuids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow_uuids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the list of Jobs belonging to Flows, based on their uuid.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        flow_uuids</span>
<span class="sd">            A list of Flow uuids.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            A list of uuids of Jobs belong to the selected Flows.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">job_uuids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">flow</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">flow_uuids</span><span class="p">}},</span> <span class="n">projection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">job_uuids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">flow</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">job_uuids</span></div>


<div class="viewcode-block" id="JobController.get_flow_jobs_data">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.get_flow_jobs_data">[docs]</a>
    <span class="k">def</span> <span class="nf">get_flow_jobs_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">projection</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the data of Flows and their Jobs from the DB using an aggregation.</span>

<span class="sd">        In the aggregation the Jobs are identified as &quot;jobs&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        query</span>
<span class="sd">            The query to filter the Flow.</span>
<span class="sd">        projection</span>
<span class="sd">            The projection for the Flow and Job data.</span>
<span class="sd">        sort</span>
<span class="sd">            Sorting passed to the aggregation.</span>
<span class="sd">        limit</span>
<span class="sd">            The maximum number of results returned.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            A list of dictionaries with the result of the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pipeline</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;$lookup&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs_collection</span><span class="p">,</span>
                    <span class="s2">&quot;localField&quot;</span><span class="p">:</span> <span class="s2">&quot;jobs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;foreignField&quot;</span><span class="p">:</span> <span class="s2">&quot;uuid&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;as&quot;</span><span class="p">:</span> <span class="s2">&quot;jobs&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">projection</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="n">projection</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$sort&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sort</span><span class="p">}})</span>

        <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$limit&quot;</span><span class="p">:</span> <span class="n">limit</span><span class="p">})</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">))</span></div>


<div class="viewcode-block" id="JobController.update_flow_state">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.update_flow_state">[docs]</a>
    <span class="k">def</span> <span class="nf">update_flow_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">flow_uuid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">updated_states</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">JobState</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the state of a Flow in the DB based on the Job&#39;s states.</span>

<span class="sd">        The Flow should be locked while performing this operation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        flow_uuid</span>
<span class="sd">            The uuid of the Flow to update.</span>
<span class="sd">        updated_states</span>
<span class="sd">            A dictionary with the updated states of Jobs that have not been</span>
<span class="sd">            stored in the DB yet. In the form {job_uuid: JobState value}.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">updated_states</span> <span class="o">=</span> <span class="n">updated_states</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;parents&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">]</span>
        <span class="n">flow_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_jobs_info_by_flow_uuid</span><span class="p">(</span>
            <span class="n">flow_uuid</span><span class="o">=</span><span class="n">flow_uuid</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span>
        <span class="p">)</span>

        <span class="n">jobs_states</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">updated_states</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">],</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">],</span> <span class="n">JobState</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">flow_jobs</span>
        <span class="p">]</span>
        <span class="n">leafs</span> <span class="o">=</span> <span class="n">get_flow_leafs</span><span class="p">(</span><span class="n">flow_jobs</span><span class="p">)</span>
        <span class="n">leaf_states</span> <span class="o">=</span> <span class="p">[</span><span class="n">JobState</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">leafs</span><span class="p">]</span>
        <span class="n">flow_state</span> <span class="o">=</span> <span class="n">FlowState</span><span class="o">.</span><span class="n">from_jobs_states</span><span class="p">(</span>
            <span class="n">jobs_states</span><span class="o">=</span><span class="n">jobs_states</span><span class="p">,</span> <span class="n">leaf_states</span><span class="o">=</span><span class="n">leaf_states</span>
        <span class="p">)</span>
        <span class="n">set_state</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">flow_state</span><span class="o">.</span><span class="n">value</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">find_one_and_update</span><span class="p">({</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="n">flow_uuid</span><span class="p">},</span> <span class="n">set_state</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobController.lock_job">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.lock_job">[docs]</a>
    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">lock_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">lock_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">MongoLock</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lock a Job document.</span>

<span class="sd">        See MongoLock context manager for more details about the locking options.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lock_kwargs</span>
<span class="sd">            Kwargs passed to the MongoLock context manager.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        MongoLock</span>
<span class="sd">            An instance of MongoLock.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">MongoLock</span><span class="p">(</span><span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">,</span> <span class="o">**</span><span class="n">lock_kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">lock</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">lock</span></div>


<div class="viewcode-block" id="JobController.lock_flow">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.lock_flow">[docs]</a>
    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">lock_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">lock_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">MongoLock</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lock a Flow document.</span>

<span class="sd">        See MongoLock context manager for more details about the locking options.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lock_kwargs</span>
<span class="sd">            Kwargs passed to the MongoLock context manager.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        MongoLock</span>
<span class="sd">            An instance of MongoLock.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">MongoLock</span><span class="p">(</span><span class="n">collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="p">,</span> <span class="o">**</span><span class="n">lock_kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">lock</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">lock</span></div>


<div class="viewcode-block" id="JobController.lock_job_for_update">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.lock_job_for_update">[docs]</a>
    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">lock_job_for_update</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">,</span>
        <span class="n">max_step_attempts</span><span class="p">,</span>
        <span class="n">delta_retry</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">MongoLock</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lock a Job document for state update by the Runner.</span>

<span class="sd">        See MongoLock context manager for more details about the locking options.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        query</span>
<span class="sd">            The query used to select the Job document to lock.</span>
<span class="sd">        max_step_attempts</span>
<span class="sd">            The maximum number of attempts for a single step after which</span>
<span class="sd">            the Job should be set to the REMOTE_ERROR state.</span>
<span class="sd">        delta_retry</span>
<span class="sd">            List of increasing delay between subsequent attempts when the</span>
<span class="sd">            advancement of a remote step fails. Used to set the retry time.</span>
<span class="sd">        kwargs</span>
<span class="sd">            Kwargs passed to the MongoLock context manager.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        MongoLock</span>
<span class="sd">            An instance of MongoLock.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db_filter</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">db_filter</span><span class="p">[</span><span class="s2">&quot;remote.retry_time_limit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$not&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$gt&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()}}</span>

        <span class="k">if</span> <span class="s2">&quot;sort&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;sort&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;priority&quot;</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">DESCENDING</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;created_on&quot;</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">ASCENDING</span><span class="p">),</span>
            <span class="p">]</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_job</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">db_filter</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="n">locked_document</span>

            <span class="n">no_retry</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">lock</span>
            <span class="k">except</span> <span class="n">ConfigError</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">no_retry</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="n">RemoteError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Remote error: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">no_retry</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">no_retry</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">set_output</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="n">update_on_release</span>

            <span class="k">if</span> <span class="n">lock</span><span class="o">.</span><span class="n">locked_document</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span><span class="p">:</span>
                    <span class="n">succeeded_update</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;remote.step_attempts&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s2">&quot;remote.retry_time_limit&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s2">&quot;remote.error&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="n">update_on_release</span> <span class="o">=</span> <span class="n">deep_merge_dict</span><span class="p">(</span>
                        <span class="n">succeeded_update</span><span class="p">,</span> <span class="n">set_output</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">step_attempts</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;remote&quot;</span><span class="p">][</span><span class="s2">&quot;step_attempts&quot;</span><span class="p">]</span>
                    <span class="n">no_retry</span> <span class="o">=</span> <span class="n">no_retry</span> <span class="ow">or</span> <span class="n">step_attempts</span> <span class="o">&gt;=</span> <span class="n">max_step_attempts</span>
                    <span class="k">if</span> <span class="n">no_retry</span><span class="p">:</span>
                        <span class="n">update_on_release</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">REMOTE_ERROR</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                <span class="s2">&quot;previous_state&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">],</span>
                                <span class="s2">&quot;remote.error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">step_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">step_attempts</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">delta_retry</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">delta</span> <span class="o">=</span> <span class="n">delta_retry</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                        <span class="n">retry_time_limit</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
                        <span class="n">update_on_release</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;remote.step_attempts&quot;</span><span class="p">:</span> <span class="n">step_attempts</span><span class="p">,</span>
                                <span class="s2">&quot;remote.retry_time_limit&quot;</span><span class="p">:</span> <span class="n">retry_time_limit</span><span class="p">,</span>
                                <span class="s2">&quot;remote.error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                <span class="k">if</span> <span class="s2">&quot;$set&quot;</span> <span class="ow">in</span> <span class="n">update_on_release</span><span class="p">:</span>
                    <span class="n">update_on_release</span><span class="p">[</span><span class="s2">&quot;$set&quot;</span><span class="p">][</span><span class="s2">&quot;updated_on&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

                <span class="n">lock</span><span class="o">.</span><span class="n">update_on_release</span> <span class="o">=</span> <span class="n">update_on_release</span></div>


<div class="viewcode-block" id="JobController.lock_job_flow">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.lock_job_flow">[docs]</a>
    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">lock_job_flow</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">db_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">break_lock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">acceptable_states</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">JobState</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_lock_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_lock_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">MongoLock</span><span class="p">,</span> <span class="n">MongoLock</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lock one Job document and the Flow document the Job belongs to.</span>

<span class="sd">        See MongoLock context manager for more details about the locking options.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_id</span>
<span class="sd">            The uuid of the Job to lock.</span>
<span class="sd">        db_id</span>
<span class="sd">            The db_id of the Job to lock.</span>
<span class="sd">        job_index</span>
<span class="sd">            The index of the Job to lock.</span>
<span class="sd">        wait</span>
<span class="sd">            The amount of seconds to wait for a lock to be released.</span>
<span class="sd">        break_lock</span>
<span class="sd">            True if the context manager is allowed to forcibly break a lock.</span>
<span class="sd">        acceptable_states</span>
<span class="sd">            A list of JobStates. If not among these a ValueError exception is</span>
<span class="sd">            raised.</span>
<span class="sd">        job_lock_kwargs</span>
<span class="sd">            Kwargs passed to MongoLock for the Job lock.</span>
<span class="sd">        flow_lock_kwargs</span>
<span class="sd">            Kwargs passed to MongoLock for the Flow lock.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        MongoLock, MongoLock</span>
<span class="sd">            An instance of MongoLock.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lock_filter</span><span class="p">,</span> <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_job_id_query</span><span class="p">(</span><span class="n">db_id</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_index</span><span class="p">)</span>
        <span class="n">sleep</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="n">sleep</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">job_lock_kwargs</span> <span class="o">=</span> <span class="n">job_lock_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">flow_lock_kwargs</span> <span class="o">=</span> <span class="n">flow_lock_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_job</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">lock_filter</span><span class="p">,</span>
            <span class="n">break_lock</span><span class="o">=</span><span class="n">break_lock</span><span class="p">,</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
            <span class="n">sleep</span><span class="o">=</span><span class="n">sleep</span><span class="p">,</span>
            <span class="n">max_wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
            <span class="n">get_locked_doc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">job_lock_kwargs</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">job_lock</span><span class="p">:</span>
            <span class="n">job_doc_dict</span> <span class="o">=</span> <span class="n">job_lock</span><span class="o">.</span><span class="n">locked_document</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job_doc_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">job_lock</span><span class="o">.</span><span class="n">unavailable_document</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">JobLockedError</span><span class="o">.</span><span class="n">from_job_doc</span><span class="p">(</span><span class="n">job_lock</span><span class="o">.</span><span class="n">unavailable_document</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No Job document matching criteria </span><span class="si">{</span><span class="n">lock_filter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">job_state</span> <span class="o">=</span> <span class="n">JobState</span><span class="p">(</span><span class="n">job_doc_dict</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">acceptable_states</span> <span class="ow">and</span> <span class="n">job_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acceptable_states</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Job in state </span><span class="si">{</span><span class="n">job_doc_dict</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. The action cannot be performed&quot;</span>
                <span class="p">)</span>

            <span class="n">flow_filter</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;jobs&quot;</span><span class="p">:</span> <span class="n">job_doc_dict</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]}</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_flow</span><span class="p">(</span>
                <span class="nb">filter</span><span class="o">=</span><span class="n">flow_filter</span><span class="p">,</span>
                <span class="n">sleep</span><span class="o">=</span><span class="n">sleep</span><span class="p">,</span>
                <span class="n">max_wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
                <span class="n">get_locked_doc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">break_lock</span><span class="o">=</span><span class="n">break_lock</span><span class="p">,</span>
                <span class="o">**</span><span class="n">flow_lock_kwargs</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">flow_lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">flow_lock</span><span class="o">.</span><span class="n">locked_document</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">flow_lock</span><span class="o">.</span><span class="n">unavailable_document</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">FlowLockedError</span><span class="o">.</span><span class="n">from_flow_doc</span><span class="p">(</span>
                            <span class="n">flow_lock</span><span class="o">.</span><span class="n">unavailable_document</span>
                        <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No Flow document matching criteria </span><span class="si">{</span><span class="n">flow_filter</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="k">yield</span> <span class="n">job_lock</span><span class="p">,</span> <span class="n">flow_lock</span></div>


<div class="viewcode-block" id="JobController.ping_flow_doc">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.ping_flow_doc">[docs]</a>
    <span class="k">def</span> <span class="nf">ping_flow_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uuid</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ping a Flow document to update its &quot;updated_on&quot; value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        uuid</span>
<span class="sd">            The uuid of the Flow to update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flows</span><span class="o">.</span><span class="n">find_one_and_update</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="n">uuid</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;updated_on&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()}}</span>
        <span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_cancel_queue_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_doc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cancel the process in the remote queue.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_doc</span>
<span class="sd">            The dict of the JobDoc with the Job to be cancelled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queue_process_id</span> <span class="o">=</span> <span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;remote&quot;</span><span class="p">][</span><span class="s2">&quot;process_id&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">queue_process_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The process id is not defined in the job document&quot;</span><span class="p">)</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">workers</span><span class="p">[</span><span class="n">job_doc</span><span class="p">[</span><span class="s2">&quot;worker&quot;</span><span class="p">]]</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">get_host</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">host</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
            <span class="n">queue_manager</span> <span class="o">=</span> <span class="n">QueueManager</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">get_scheduler_io</span><span class="p">(),</span> <span class="n">host</span><span class="p">)</span>
            <span class="n">cancel_result</span> <span class="o">=</span> <span class="n">queue_manager</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="n">queue_process_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cancel_result</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CancelStatus</span><span class="o">.</span><span class="n">SUCCESSFUL</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cancelling queue process </span><span class="si">{</span><span class="n">queue_process_id</span><span class="si">}</span><span class="s2"> failed. stdout: </span><span class="si">{</span><span class="n">cancel_result</span><span class="o">.</span><span class="n">stdout</span><span class="si">}</span><span class="s2">. stderr: </span><span class="si">{</span><span class="n">cancel_result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">host</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The connection to host </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2"> could not be closed.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

<div class="viewcode-block" id="JobController.get_batch_processes">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.get_batch_processes">[docs]</a>
    <span class="k">def</span> <span class="nf">get_batch_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the batch processes associated with a given worker.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        worker</span>
<span class="sd">            The worker name.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary with the {process_id: process_uuid} of the batch</span>
<span class="sd">            jobs running on the selected worker.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;batch_processes&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}})</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;batch_processes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="JobController.add_batch_process">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.add_batch_process">[docs]</a>
    <span class="k">def</span> <span class="nf">add_batch_process</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">process_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">process_uuid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">worker</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a batch process to the list of running processes.</span>

<span class="sd">        Two IDs are defined, one to keep track of the actual process number and one</span>
<span class="sd">        to be associated to the Jobs that are being executed. The need for two IDs</span>
<span class="sd">        originates from the fact that the former may not be known at runtime.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        process_id</span>
<span class="sd">            The ID of the processes obtained from the QueueManager.</span>
<span class="sd">        process_uuid</span>
<span class="sd">            A unique ID to identify the processes.</span>
<span class="sd">        worker</span>
<span class="sd">            The worker where the process is being executed.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            The updated document.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">find_one_and_update</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;batch_processes&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}},</span>
            <span class="p">{</span><span class="s2">&quot;$push&quot;</span><span class="p">:</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;batch_processes.</span><span class="si">{</span><span class="n">worker</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">process_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">process_uuid</span><span class="p">}},</span>
            <span class="n">upsert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="JobController.remove_batch_process">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.JobController.remove_batch_process">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_batch_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">worker</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove a process from the list of running batch processes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        process_id</span>
<span class="sd">            The ID of the processes obtained from the QueueManager.</span>
<span class="sd">        worker</span>
<span class="sd">            The worker where the process was being executed.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            The updated document.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">find_one_and_update</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;batch_processes&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}},</span>
            <span class="p">{</span><span class="s2">&quot;$unset&quot;</span><span class="p">:</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;batch_processes.</span><span class="si">{</span><span class="n">worker</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">process_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}},</span>
            <span class="n">upsert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="get_flow_leafs">
<a class="viewcode-back" href="../../../api/jobflow_remote.jobs.jobcontroller.html#jobflow_remote.jobs.jobcontroller.get_flow_leafs">[docs]</a>
<span class="k">def</span> <span class="nf">get_flow_leafs</span><span class="p">(</span><span class="n">job_docs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the leaf jobs from a list of serilized representation of JobDoc.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    job_docs</span>
<span class="sd">        The list of serialized JobDocs in the Flow</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        The list of serialized JobDocs that are leafs of the Flow.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># first sort the list, so that only the largest indexes are kept in the dictionary</span>
    <span class="n">job_docs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">job_docs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">j</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">j</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]:</span> <span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">job_docs</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">job_docs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">j</span><span class="p">[</span><span class="s2">&quot;parents&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">parent_id</span> <span class="ow">in</span> <span class="n">j</span><span class="p">[</span><span class="s2">&quot;parents&quot;</span><span class="p">]:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">parent_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>

</pre></div>

                </article>





                <footer class="prev-next-footer">

<div class="prev-next-area">
</div>
                </footer>

            </div>




          </div>
          <footer class="bd-footer-content">

          </footer>

      </main>
    </div>
  </div>

  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">

    <div class="footer-items__start">

        <div class="footer-item">

  <p class="copyright">

      © Copyright 2023, Matgenix SRL.
      <br/>

  </p>
</div>

        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>

    </div>



    <div class="footer-items__end">

        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.14.4.
</p></div>

    </div>

</div>

  </footer>
  </body>
</html>
